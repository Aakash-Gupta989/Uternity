<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task 2 Improved Flow Test - TOEFL Speaking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            min-height: 100vh;
            color: #1f2937;
        }
        
        .dashboard-card {
            background: linear-gradient(135deg, #ffffff 0%, #fefefe 100%);
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            box-shadow: 
                0 10px 25px -5px rgba(0, 0, 0, 0.08),
                0 8px 10px -6px rgba(0, 0, 0, 0.05),
                0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .timer-display {
            font-family: 'Courier New', monospace;
            font-size: 2rem;
            font-weight: bold;
        }
        
        .phase-indicator {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: bold;
            text-align: center;
        }
        
        .phase-indicator.introduction {
            background: linear-gradient(135deg, #f3e8ff, #e9d5ff);
            color: #7c3aed;
            border: 2px solid #a855f7;
        }
        
        .phase-indicator.reading {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1e40af;
            border: 2px solid #3b82f6;
        }
        
        .phase-indicator.listening {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            color: #16a34a;
            border: 2px solid #22c55e;
        }
        
        .phase-indicator.preparation {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #d97706;
            border: 2px solid #f59e0b;
        }
        
        .phase-indicator.response {
            background: linear-gradient(135deg, #fecaca, #fca5a5);
            color: #dc2626;
            border: 2px solid #ef4444;
        }
        
        .record-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }
        
        .record-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.6);
        }
        
        .record-btn.recording {
            background: linear-gradient(135deg, #10b981, #059669);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="dashboard-card p-6 mb-6">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">TOEFL Speaking Test - Task 2 Improved Flow</h1>
                <p class="text-gray-600">Testing the enhanced Task 2 flow with proper announcements and visual indicators</p>
            </div>

            <!-- Test Controls -->
            <div class="dashboard-card p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Test Controls</h2>
                <div class="flex flex-wrap gap-4">
                    <button onclick="startImprovedTask2()" class="bg-purple-500 text-white px-6 py-3 rounded-lg hover:bg-purple-600 font-medium">
                        Start Improved Task 2 Flow
                    </button>
                    <button onclick="stopAllAudio()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                        Stop All Audio
                    </button>
                    <button onclick="testVoices()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
                        Test Voices
                    </button>
                </div>
            </div>

            <!-- Timer and Phase Display -->
            <div class="dashboard-card p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <div class="text-center">
                        <div class="timer-display text-blue-600" id="timer-display">00:00</div>
                        <div class="text-sm text-gray-500">Time Remaining</div>
                    </div>
                    <div class="phase-indicator introduction" id="phase-indicator">
                        Get Ready...
                    </div>
                </div>
                <div class="text-center">
                    <div class="text-gray-600 mb-4" id="current-instruction">Click "Start Improved Task 2 Flow" to begin</div>
                    <button class="record-btn hidden" id="record-btn">
                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2a3 3 0 0 1 3 3v6a3 3 0 0 1-6 0V5a3 3 0 0 1 3-3z"/>
                            <path d="M19 10v1a7 7 0 0 1-14 0v-1"/>
                            <path d="M12 18v4"/>
                            <path d="M8 22h8"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Content Display -->
            <div class="dashboard-card p-6 mb-6">
                <div id="content-display">
                    <!-- Content will be dynamically inserted here -->
                </div>
            </div>

            <!-- Flow Progress -->
            <div class="dashboard-card p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Task 2 Flow Progress</h2>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div class="text-center p-4 bg-gray-100 rounded-lg" id="step-1">
                        <div class="w-8 h-8 bg-gray-400 rounded-full mx-auto mb-2 flex items-center justify-center text-white font-bold">1</div>
                        <div class="text-sm font-medium">Introduction</div>
                        <div class="text-xs text-gray-500">Task announcement</div>
                    </div>
                    <div class="text-center p-4 bg-gray-100 rounded-lg" id="step-2">
                        <div class="w-8 h-8 bg-gray-400 rounded-full mx-auto mb-2 flex items-center justify-center text-white font-bold">2</div>
                        <div class="text-sm font-medium">Reading</div>
                        <div class="text-xs text-gray-500">Silent reading</div>
                    </div>
                    <div class="text-center p-4 bg-gray-100 rounded-lg" id="step-3">
                        <div class="w-8 h-8 bg-gray-400 rounded-full mx-auto mb-2 flex items-center justify-center text-white font-bold">3</div>
                        <div class="text-sm font-medium">Listening</div>
                        <div class="text-xs text-gray-500">Two-voice conversation</div>
                    </div>
                    <div class="text-center p-4 bg-gray-100 rounded-lg" id="step-4">
                        <div class="w-8 h-8 bg-gray-400 rounded-full mx-auto mb-2 flex items-center justify-center text-white font-bold">4</div>
                        <div class="text-sm font-medium">Question</div>
                        <div class="text-xs text-gray-500">Question display</div>
                    </div>
                    <div class="text-center p-4 bg-gray-100 rounded-lg" id="step-5">
                        <div class="w-8 h-8 bg-gray-400 rounded-full mx-auto mb-2 flex items-center justify-center text-white font-bold">5</div>
                        <div class="text-sm font-medium">Response</div>
                        <div class="text-xs text-gray-500">Recording</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Test data
        const testContent = {
            question_prompt: "The woman expresses her opinion about the university's plan to eliminate the bus service. State her opinion and explain the reasons she gives for holding that opinion.",
            instructions: "You have 30 seconds to prepare your response and 60 seconds to speak.",
            reading_passage: "University Announces Changes to Campus Transportation\n\nEffective next semester, the university will eliminate the free bus service that currently runs between the main campus and the downtown campus. The administration has decided that the bus service is too expensive to maintain and is being used by too few students to justify the cost. Instead, students will be encouraged to use the new bike-sharing program or the public transportation system. The university will provide discounted public transit passes to all students who request them.",
            listening_script: "Female Student: I can't believe they're getting rid of the bus service! This is such a bad decision.\n\nMale Student: Really? I thought hardly anyone used it anyway.\n\nFemale Student: That's not true at all! I use it every day to get to my internship downtown, and I see the same people on there all the time. The thing is, a lot of students don't even know about it because the university doesn't advertise it well.\n\nMale Student: But they're offering discounted public transit passes instead.\n\nFemale Student: Yeah, but that's still going to cost money, and the public buses don't run as frequently as the university bus. Plus, the bike-sharing program is useless in winter when it's snowing and freezing outside. They're basically making it harder for students who don't have cars to get around, and that's not fair."
        };

        // Improved flow phases with proper timing
        const improvedFlow = [
            { 
                phase: 'introduction', 
                duration: 8000,
                announcement: "Task 2 starts now. In this task, you will read a passage and listen to a conversation between two students. Then you will answer a question about the woman's opinion."
            },
            { 
                phase: 'reading', 
                duration: 50000,
                announcement: "Now you will read a passage. Read the passage silently by yourself. You have 50 seconds to read."
            },
            { 
                phase: 'listening', 
                duration: 75000,
                announcement: "Now you will listen to a conversation between two students. Listen carefully."
            },
            { 
                phase: 'preparation', 
                duration: 30000,
                announcement: "Now here is the question you need to answer:"
            },
            { 
                phase: 'response', 
                duration: 60000,
                announcement: "Begin speaking now. You have 60 seconds to respond."
            }
        ];

        let currentPhaseIndex = 0;
        let phaseTimer = null;
        let countdownTimer = null;
        let isRecording = false;

        function startImprovedTask2() {
            console.log("🚀 Starting improved Task 2 flow");
            currentPhaseIndex = 0;
            stopAllAudio();
            resetProgress();
            runImprovedPhase(improvedFlow[currentPhaseIndex]);
        }

        function runImprovedPhase(phaseData) {
            console.log(`🔄 Running improved phase: ${phaseData.phase}`);
            
            // Update phase display
            updatePhaseDisplay(phaseData.phase);
            
            // Update progress indicator
            updateProgress(currentPhaseIndex + 1);
            
            // Update content for current phase
            updateContentDisplay(phaseData.phase);
            
            // Start countdown timer
            startCountdownTimer(phaseData.duration);
            
            // Play announcement
            setTimeout(() => {
                playAnnouncement(phaseData.announcement);
            }, 500);
            
            // Handle phase-specific actions
            switch (phaseData.phase) {
                case 'listening':
                    setTimeout(() => {
                        playConversationAudio(testContent.listening_script);
                    }, 4000); // Wait for announcement to finish
                    break;
                case 'preparation':
                    setTimeout(() => {
                        playQuestionAudio(testContent.question_prompt);
                    }, 3000); // Wait for announcement
                    break;
                case 'response':
                    setTimeout(() => {
                        startRecording();
                    }, 2000);
                    break;
            }
            
            // Set timer for next phase
            phaseTimer = setTimeout(() => {
                currentPhaseIndex++;
                if (currentPhaseIndex < improvedFlow.length) {
                    runImprovedPhase(improvedFlow[currentPhaseIndex]);
                } else {
                    console.log("🏁 Improved Task 2 flow completed");
                    stopAllAudio();
                    document.getElementById('current-instruction').textContent = 'Task 2 completed! Great job!';
                }
            }, phaseData.duration);
        }

        function updatePhaseDisplay(phase) {
            const phaseIndicator = document.getElementById('phase-indicator');
            const instruction = document.getElementById('current-instruction');
            const recordBtn = document.getElementById('record-btn');
            
            // Update phase indicator
            phaseIndicator.className = `phase-indicator ${phase}`;
            
            switch (phase) {
                case 'introduction':
                    phaseIndicator.textContent = 'Introduction';
                    instruction.textContent = 'Listen to the task introduction';
                    recordBtn.style.display = 'none';
                    break;
                case 'reading':
                    phaseIndicator.textContent = 'Reading Time';
                    instruction.textContent = 'Read the passage silently by yourself';
                    recordBtn.style.display = 'none';
                    break;
                case 'listening':
                    phaseIndicator.textContent = 'Listening Time';
                    instruction.textContent = 'Listen to the conversation carefully';
                    recordBtn.style.display = 'none';
                    break;
                case 'preparation':
                    phaseIndicator.textContent = 'Preparation Time';
                    instruction.textContent = 'Prepare your response - think about your answer';
                    recordBtn.style.display = 'none';
                    break;
                case 'response':
                    phaseIndicator.textContent = 'Response Time';
                    instruction.textContent = 'Speak your response now!';
                    recordBtn.style.display = 'flex';
                    break;
            }
        }

        function updateContentDisplay(phase) {
            const contentDiv = document.getElementById('content-display');
            let content = '';
            
            switch (phase) {
                case 'introduction':
                    content = `
                        <div class="mb-6 p-4 bg-gradient-to-r from-purple-50 to-blue-50 border-2 border-purple-200 rounded-lg">
                            <h4 class="font-bold text-purple-900 mb-3 text-lg flex items-center">
                                🎯 Task 2 Introduction
                            </h4>
                            <p class="text-purple-800 text-base font-medium mb-2">Listen carefully to the task instructions.</p>
                            <p class="text-purple-600 text-sm">This is an integrated speaking task with reading and listening.</p>
                        </div>
                    `;
                    break;
                case 'reading':
                    content = `
                        <div class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-lg">
                            <h4 class="font-bold text-blue-900 mb-3 text-lg flex items-center">
                                📖 Reading Phase
                            </h4>
                            <p class="text-blue-800 text-base font-medium mb-2">Read the passage silently by yourself.</p>
                            <p class="text-blue-600 text-sm">You have 50 seconds to read. Do not read aloud.</p>
                        </div>
                        <div class="mb-6 p-4 bg-white border-2 border-blue-300 rounded-lg">
                            <h4 class="font-bold text-blue-900 mb-3 text-lg">📖 Reading Passage</h4>
                            <div class="text-gray-800 text-base leading-relaxed whitespace-pre-line">${testContent.reading_passage}</div>
                        </div>
                    `;
                    break;
                case 'listening':
                    content = `
                        <div class="mb-6 p-4 bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-lg">
                            <h4 class="font-bold text-green-900 mb-3 text-lg flex items-center">
                                🔊 Listening Phase
                            </h4>
                            <p class="text-green-800 text-base font-medium mb-2">Listen to the conversation between two students.</p>
                            <p class="text-green-600 text-sm">You will hear it once with two different voices. Listen carefully.</p>
                        </div>
                        <div class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                            <h4 class="font-semibold text-green-900 mb-2">🔊 Listening in Progress</h4>
                            <div class="text-green-800 text-sm">
                                <div class="flex items-center space-x-2">
                                    <div class="animate-pulse w-2 h-2 bg-green-500 rounded-full"></div>
                                    <span>Conversation between two students playing...</span>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'preparation':
                case 'response':
                    content = `
                        <div class="mb-6 p-4 bg-gradient-to-r from-yellow-50 to-orange-50 border-2 border-yellow-300 rounded-lg">
                            <h4 class="font-bold text-yellow-900 mb-3 text-lg flex items-center">
                                ❓ Your Question
                            </h4>
                            <p class="text-yellow-800 font-medium text-base leading-relaxed">${testContent.question_prompt}</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                <h4 class="font-semibold text-blue-900 mb-2">Reading Reference:</h4>
                                <div class="text-blue-800 text-sm">${testContent.reading_passage.substring(0, 200)}...</div>
                            </div>
                            <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                                <h4 class="font-semibold text-green-900 mb-2">Conversation Reference:</h4>
                                <div class="text-green-800 text-sm">${testContent.listening_script.substring(0, 200)}...</div>
                            </div>
                        </div>
                    `;
                    break;
            }
            
            contentDiv.innerHTML = content;
        }

        function updateProgress(step) {
            for (let i = 1; i <= 5; i++) {
                const stepElement = document.getElementById(`step-${i}`);
                const circle = stepElement.querySelector('.w-8');
                
                if (i < step) {
                    // Completed
                    stepElement.className = 'text-center p-4 bg-green-100 rounded-lg';
                    circle.className = 'w-8 h-8 bg-green-500 rounded-full mx-auto mb-2 flex items-center justify-center text-white font-bold';
                } else if (i === step) {
                    // Current
                    stepElement.className = 'text-center p-4 bg-blue-100 rounded-lg';
                    circle.className = 'w-8 h-8 bg-blue-500 rounded-full mx-auto mb-2 flex items-center justify-center text-white font-bold';
                } else {
                    // Future
                    stepElement.className = 'text-center p-4 bg-gray-100 rounded-lg';
                    circle.className = 'w-8 h-8 bg-gray-400 rounded-full mx-auto mb-2 flex items-center justify-center text-white font-bold';
                }
            }
        }

        function resetProgress() {
            updateProgress(0);
        }

        function startCountdownTimer(duration) {
            if (countdownTimer) {
                clearInterval(countdownTimer);
            }
            
            let timeLeft = Math.floor(duration / 1000);
            updateTimerDisplay(timeLeft);
            
            countdownTimer = setInterval(() => {
                timeLeft--;
                updateTimerDisplay(timeLeft);
                
                if (timeLeft <= 0) {
                    clearInterval(countdownTimer);
                }
            }, 1000);
        }

        function updateTimerDisplay(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            document.getElementById('timer-display').textContent = display;
        }

        function playAnnouncement(text) {
            if (!speechSynthesis) return;
            
            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.85;
            utterance.pitch = 1.0;
            utterance.volume = 0.9;
            
            const voices = speechSynthesis.getVoices();
            const preferredVoice = voices.find(voice => 
                voice.name.includes('Karen') || 
                voice.name.includes('Samantha') ||
                voice.name.includes('Daniel') ||
                voice.lang.startsWith('en-US')
            );
            
            if (preferredVoice) {
                utterance.voice = preferredVoice;
            }
            
            console.log("🔊 Playing announcement:", text);
            speechSynthesis.speak(utterance);
        }

        function playQuestionAudio(text) {
            if (!speechSynthesis) return;
            
            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            utterance.pitch = 1.0;
            utterance.volume = 0.8;
            
            console.log("🔊 Playing question:", text);
            speechSynthesis.speak(utterance);
        }

        function playConversationAudio(conversationText) {
            if (!speechSynthesis) return;
            
            console.log("🔊 Playing conversation with two voices");
            
            const lines = conversationText.split('\n').filter(line => line.trim());
            const voices = speechSynthesis.getVoices();
            
            const femaleVoice = voices.find(voice => 
                voice.name.includes('Karen') || 
                voice.name.includes('Samantha') ||
                voice.name.includes('Victoria') ||
                voice.name.includes('Susan')
            ) || voices.find(voice => voice.lang.startsWith('en-US'));
            
            const maleVoice = voices.find(voice => 
                voice.name.includes('Daniel') || 
                voice.name.includes('Alex') ||
                voice.name.includes('David') ||
                voice.name.includes('Tom') ||
                voice.name.includes('Aaron') ||
                voice.name.includes('Fred')
            ) || voices.find(voice => voice.lang.startsWith('en-US') && voice !== femaleVoice);
            
            console.log("🎭 Using voices - Female:", femaleVoice?.name, "Male:", maleVoice?.name);
            
            function speakNextLine(lineIndex) {
                if (lineIndex >= lines.length) {
                    console.log("🔊 Conversation completed");
                    return;
                }
                
                const line = lines[lineIndex].trim();
                if (!line) {
                    speakNextLine(lineIndex + 1);
                    return;
                }
                
                let voice = femaleVoice;
                let speakerName = '';
                
                if (line.includes('Female Student:')) {
                    voice = femaleVoice;
                    speakerName = 'Female Student';
                } else if (line.includes('Male Student:')) {
                    voice = maleVoice;
                    speakerName = 'Male Student';
                }
                
                const cleanText = line
                    .replace(/^(Female Student:|Male Student:)\s*/, '')
                    .trim();
                
                if (!cleanText) {
                    speakNextLine(lineIndex + 1);
                    return;
                }
                
                const utterance = new SpeechSynthesisUtterance(cleanText);
                utterance.voice = voice;
                utterance.rate = 0.85;
                utterance.pitch = voice === femaleVoice ? 1.1 : 0.8;
                utterance.volume = 0.9;
                
                utterance.onend = () => {
                    setTimeout(() => {
                        speakNextLine(lineIndex + 1);
                    }, 500);
                };
                
                utterance.onerror = () => {
                    speakNextLine(lineIndex + 1);
                };
                
                console.log(`🔊 Speaking as ${speakerName}:`, cleanText.substring(0, 50) + "...");
                speechSynthesis.speak(utterance);
            }
            
            speakNextLine(0);
        }

        function startRecording() {
            const recordBtn = document.getElementById('record-btn');
            recordBtn.classList.add('recording');
            recordBtn.innerHTML = `
                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                    <rect x="6" y="6" width="12" height="12" rx="2"/>
                </svg>
            `;
            document.getElementById('current-instruction').textContent = '🎤 Recording... Speak your response now!';
            console.log("🎤 Recording started (simulation)");
        }

        function stopAllAudio() {
            if (speechSynthesis) {
                speechSynthesis.cancel();
            }
            if (phaseTimer) {
                clearTimeout(phaseTimer);
                phaseTimer = null;
            }
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }
            console.log("🔇 All audio stopped");
        }

        function testVoices() {
            const voices = speechSynthesis.getVoices();
            console.log("Available voices:", voices.map(v => `${v.name} (${v.lang})`));
            alert(`Found ${voices.length} voices. Check console for details.`);
        }

        // Initialize voices when page loads
        window.addEventListener('load', () => {
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = () => {
                    console.log("Voices loaded");
                };
            }
        });
    </script>
</body>
</html> 