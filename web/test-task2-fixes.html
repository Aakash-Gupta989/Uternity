<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task 2 TOEFL Fixes - Comprehensive Test</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            min-height: 100vh;
            color: #1f2937;
        }
        .test-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        .timer-display {
            background: linear-gradient(135deg, #8b5cf6 0%, #06b6d4 100%);
            color: white;
            font-size: 2rem;
            font-weight: bold;
            padding: 24px;
            text-align: center;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
        }
        .phase-indicator {
            display: inline-flex;
            align-items: center;
            padding: 12px 20px;
            border-radius: 16px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .phase-indicator.preparation {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #d97706;
            border: 1px solid #fbbf24;
        }
        .phase-indicator.response {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            color: #16a34a;
            border: 1px solid #22c55e;
        }
        .record-button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            font-size: 1.5rem;
            font-weight: bold;
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }
        .record-button.recording {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            animation: pulse 2s infinite;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .content-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .audio-indicator {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border: 1px solid #22c55e;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        .audio-indicator .pulse-dot {
            width: 8px;
            height: 8px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        .phase-content {
            min-height: 200px;
        }
        .recording-status {
            background: #f3f4f6;
            border-radius: 8px;
            padding: 12px;
            margin-top: 16px;
            font-family: monospace;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="text-3xl font-bold text-center mb-8">Task 2 TOEFL Fixes - Complete Test</h1>
        
        <div class="timer-display">
            <div id="timer">00:00</div>
            <div class="text-sm mt-2" id="current-phase-time">Ready to test</div>
        </div>
        
        <div class="text-center mb-6">
            <div class="phase-indicator preparation" id="phase-indicator">Test Ready</div>
        </div>
        
        <div class="content-section">
            <h2 class="text-xl font-semibold mb-4">Task 2: Campus Situation Test</h2>
            <div class="space-y-4">
                <button onclick="startFullTask2Test()" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 font-semibold">
                    Start Complete Task 2 Test (Authentic)
                </button>
                <button onclick="testConversationNarration()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                    Test Conversation (Two Voices)
                </button>
                <button onclick="testQuestionReading()" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">
                    Test Question Reading
                </button>
                <button onclick="testRecording()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                    Test Recording
                </button>
            </div>
        </div>
        
        <div class="content-section phase-content">
            <h3 class="text-lg font-semibold mb-3">Current Phase Content</h3>
            <div id="question-content">
                <div id="question-text">Ready to start testing...</div>
                <div id="additional-content"></div>
            </div>
        </div>
        
        <div class="text-center">
            <div class="record-button" id="record-btn" style="display: none;">
                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2a3 3 0 0 1 3 3v6a3 3 0 0 1-6 0V5a3 3 0 0 1 3-3z"/>
                    <path d="M19 10v1a7 7 0 0 1-14 0v-1"/>
                    <path d="M12 18v4"/>
                    <path d="M8 22h8"/>
                </svg>
            </div>
            <p class="text-sm text-gray-600 mt-4" id="record-instruction">Ready to test</p>
        </div>
        
        <div class="content-section">
            <h3 class="text-lg font-semibold mb-3">Recording Status</h3>
            <div class="recording-status" id="recording-status">
                Recording system not initialized
            </div>
        </div>
        
        <div class="content-section">
            <h3 class="text-lg font-semibold mb-3">Task 2 Fixes Verification (Authentic TOEFL)</h3>
            <div class="space-y-2 text-sm">
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 bg-yellow-500 rounded-full" id="fix1-status"></div>
                    <span>Silent Reading (No Narration)</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 bg-yellow-500 rounded-full" id="fix2-status"></div>
                    <span>Conversation with Two Distinct Voices</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 bg-yellow-500 rounded-full" id="fix3-status"></div>
                    <span>Question Reading (Verbal)</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 bg-yellow-500 rounded-full" id="fix4-status"></div>
                    <span>Auto Recording After Preparation</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 bg-yellow-500 rounded-full" id="fix5-status"></div>
                    <span>Recording Data Collection</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Task 2 demo content
        const task2Content = {
            task_type: "task_2_campus",
            metadata: {
                content_id: "task2_demo_001",
                title: "Library Hours Extension",
                difficulty: "intermediate",
                topic: "Campus Life"
            },
            question_prompt: "The man expresses his opinion about the library's new extended hours. State his opinion and explain the reasons he gives for holding that opinion.",
            instructions: "You will read a short passage, then listen to a conversation. You will then speak about the student's opinion.",
            reading_passage: `Notice: Extended Library Hours

The university library will extend its operating hours starting next month. The library will now be open until 2:00 AM on weekdays and until midnight on weekends. This change comes in response to student requests for more study time, especially during exam periods.

The extended hours will require hiring additional staff for security and maintenance. The library administration believes this investment will significantly improve student academic success and satisfaction.`,
            listening_script: `Female Student: Did you see this notice about the library hours?

Male Student: Yeah, I think it's fantastic! I've been hoping for something like this for years.

Female Student: Really? I'm not sure it's worth the extra cost.

Male Student: Are you kidding? This is going to be so helpful, especially during finals week. You know how crowded the library gets during the day. I can never find a quiet spot to study.

Female Student: That's true, but won't it be expensive to keep the building open so late?

Male Student: Sure, but think about it - we're paying a lot of money for our education. Having access to study space when we need it most is totally worth it. Plus, some of us have jobs during the day, so we can only study at night. This gives us a real place to focus instead of trying to study in our noisy dorm rooms.

Female Student: I hadn't thought about that. I guess it would help a lot of students.

Male Student: Exactly! And the library has all the resources we need - computers, research databases, group study rooms. It's much better than staying up late in the dorm trying to concentrate with roommates coming and going.`
        };

        let currentTimer = null;
        let isRecording = false;
        let mediaRecorder = null;
        let audioStream = null;
        let recordedChunks = [];
        let currentPhase = '';
        
        function updateTimerDisplay(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            const timeString = `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            
            document.getElementById('timer').textContent = timeString;
            document.getElementById('current-phase-time').textContent = `${seconds} seconds remaining`;
        }
        
        function updatePhaseIndicator(phase, text) {
            const indicator = document.getElementById('phase-indicator');
            indicator.classList.remove('preparation', 'response');
            indicator.classList.add(phase);
            indicator.textContent = text;
            currentPhase = phase;
        }
        
        function updateRecordButton(show, recording = false) {
            const button = document.getElementById('record-btn');
            const instruction = document.getElementById('record-instruction');
            
            if (show) {
                button.style.display = 'flex';
                if (recording) {
                    button.classList.add('recording');
                    instruction.textContent = 'ðŸŽ¤ Recording... Speak now!';
                } else {
                    button.classList.remove('recording');
                    instruction.textContent = 'Recording will start automatically...';
                }
            } else {
                button.style.display = 'none';
            }
        }
        
        function updateContent(content, phase) {
            const questionElement = document.getElementById('question-text');
            const additionalElement = document.getElementById('additional-content');
            
            let questionHTML = '';
            let additionalHTML = '';
            
            if (phase === 'introduction') {
                questionHTML = `
                    <div class="mb-4">
                        <h4 class="font-semibold text-gray-900 mb-2">Instructions:</h4>
                        <p class="text-gray-600 text-sm">${content.instructions}</p>
                    </div>
                    <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <p class="text-blue-800 text-sm">ðŸ”Š Listen carefully to the instructions and question.</p>
                    </div>
                `;
            } else if (phase === 'reading') {
                questionHTML = `
                    <div class="mb-4">
                        <h4 class="font-semibold text-gray-900 mb-2">Instructions:</h4>
                        <p class="text-gray-600 text-sm">Listen to the reading passage. You will hear it read aloud.</p>
                    </div>
                    <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <p class="text-blue-800 text-sm">ðŸ“– The reading passage will be narrated. Listen carefully.</p>
                    </div>
                `;
                
                additionalHTML = `
                    <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <h4 class="font-semibold text-blue-900 mb-2">ðŸ“– Reading Passage (Being Narrated)</h4>
                        <div class="text-blue-800 text-sm">
                            <div class="flex items-center space-x-2">
                                <div class="animate-pulse w-2 h-2 bg-blue-500 rounded-full"></div>
                                <span>Listen as the passage is read aloud...</span>
                            </div>
                        </div>
                    </div>
                `;
            } else if (phase === 'listening') {
                questionHTML = `
                    <div class="mb-4">
                        <h4 class="font-semibold text-gray-900 mb-2">Instructions:</h4>
                        <p class="text-gray-600 text-sm">Listen to the conversation. You will hear it once.</p>
                    </div>
                `;
                
                additionalHTML = `
                    <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <h4 class="font-semibold text-blue-900 mb-2">Reading Passage (Reference):</h4>
                        <div class="text-blue-800 text-sm whitespace-pre-line">${content.reading_passage}</div>
                    </div>
                    <div class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                        <h4 class="font-semibold text-green-900 mb-2">ðŸ”Š Listening Phase</h4>
                        <div class="text-green-800 text-sm">
                            <div class="flex items-center space-x-2">
                                <div class="animate-pulse w-2 h-2 bg-green-500 rounded-full"></div>
                                <span>Listen carefully to the conversation...</span>
                            </div>
                        </div>
                    </div>
                `;
            } else if (phase === 'preparation' || phase === 'response') {
                questionHTML = `
                    <div class="mb-4">
                        <h4 class="font-semibold text-gray-900 mb-2">Question:</h4>
                        <p class="text-gray-700">${content.question_prompt}</p>
                    </div>
                    <div class="mb-4">
                        <h4 class="font-semibold text-gray-900 mb-2">Instructions:</h4>
                        <p class="text-gray-600 text-sm">${content.instructions}</p>
                    </div>
                `;
                
                additionalHTML = `
                    <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <h4 class="font-semibold text-blue-900 mb-2">Reading Passage (Reference):</h4>
                        <div class="text-blue-800 text-sm whitespace-pre-line">${content.reading_passage}</div>
                    </div>
                    <div class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                        <h4 class="font-semibold text-green-900 mb-2">Conversation (Reference):</h4>
                        <div class="text-green-800 text-sm whitespace-pre-line">${content.listening_script}</div>
                    </div>
                `;
            }
            
            questionElement.innerHTML = questionHTML;
            additionalElement.innerHTML = additionalHTML;
        }
        
        function playAudio(text, rate = 0.9, onEnd = null) {
            if (!speechSynthesis) {
                alert('Speech synthesis not supported in this browser');
                return;
            }
            
            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = rate;
            utterance.pitch = 1.0;
            utterance.volume = 0.8;
            
            if (onEnd) {
                utterance.onend = onEnd;
            }
            
            console.log(`ðŸ”Š Playing audio (rate: ${rate}):`, text.substring(0, 50) + '...');
            speechSynthesis.speak(utterance);
        }
        
        async function initializeRecording() {
            try {
                console.log("ðŸŽ¤ Initializing recording...");
                updateRecordingStatus("Requesting microphone access...");
                
                audioStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    } 
                });
                
                mediaRecorder = new MediaRecorder(audioStream);
                recordedChunks = [];
                
                mediaRecorder.ondataavailable = function(event) {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                        console.log("ðŸŽ¤ Recording data chunk:", event.data.size, "bytes");
                        updateRecordingStatus(`Recording... ${recordedChunks.length} chunks, ${event.data.size} bytes`);
                    }
                };
                
                mediaRecorder.onstop = function() {
                    console.log("ðŸŽ¤ Recording stopped. Total chunks:", recordedChunks.length);
                    const blob = new Blob(recordedChunks, { type: 'audio/webm' });
                    updateRecordingStatus(`Recording completed: ${blob.size} bytes total`);
                    updateFixStatus('fix5-status', true);
                };
                
                mediaRecorder.onstart = function() {
                    console.log("ðŸŽ¤ Recording started successfully");
                    updateRecordingStatus("Recording active...");
                };
                
                updateRecordingStatus("Recording system ready");
                console.log("ðŸŽ¤ Recording initialized successfully");
                return true;
            } catch (error) {
                console.error("âŒ Error initializing recording:", error);
                updateRecordingStatus(`Recording initialization failed: ${error.message}`);
                return false;
            }
        }
        
        function updateRecordingStatus(status) {
            document.getElementById('recording-status').textContent = status;
        }
        
        function updateFixStatus(elementId, success) {
            const element = document.getElementById(elementId);
            element.className = `w-3 h-3 rounded-full ${success ? 'bg-green-500' : 'bg-red-500'}`;
        }
        
        async function startFullTask2Test() {
            console.log('ðŸš€ Starting complete Task 2 test');
            
            // Initialize recording first
            const recordingReady = await initializeRecording();
            if (!recordingReady) {
                alert('Recording initialization failed. Please allow microphone access.');
                return;
            }
            
            // Phase 1: Introduction
            updatePhaseIndicator('preparation', 'Introduction');
            updateContent(task2Content, 'introduction');
            document.getElementById('record-instruction').textContent = 'Listen to the instructions and question';
            
            setTimeout(() => {
                playAudio(task2Content.instructions + ". " + task2Content.question_prompt, 0.9, () => {
                    updateFixStatus('fix3-status', true);
                    setTimeout(() => startReadingPhase(), 1000);
                });
            }, 1000);
            
            // Start timer
            let timeLeft = 5;
            updateTimerDisplay(timeLeft);
            const introTimer = setInterval(() => {
                timeLeft--;
                updateTimerDisplay(timeLeft);
                if (timeLeft <= 0) {
                    clearInterval(introTimer);
                }
            }, 1000);
        }
        
        function startReadingPhase() {
            console.log('ðŸ“– Starting reading phase');
            updatePhaseIndicator('preparation', 'Reading Time');
            updateContent(task2Content, 'reading');
            document.getElementById('record-instruction').textContent = 'Read the passage silently';
            
            // Mark reading as completed (students read silently)
            updateFixStatus('fix1-status', true);
            
            // Reading timer
            let timeLeft = 50;
            updateTimerDisplay(timeLeft);
            const readingTimer = setInterval(() => {
                timeLeft--;
                updateTimerDisplay(timeLeft);
                if (timeLeft <= 0) {
                    clearInterval(readingTimer);
                    startListeningPhase();
                }
            }, 1000);
        }
        
        function startListeningPhase() {
            console.log('ðŸ”Š Starting listening phase');
            updatePhaseIndicator('preparation', 'Listening Time');
            updateContent(task2Content, 'listening');
            document.getElementById('record-instruction').textContent = 'Listen to the conversation';
            
            setTimeout(() => {
                playConversationWithTwoVoices(task2Content.listening_script, () => {
                    updateFixStatus('fix2-status', true);
                    document.getElementById('record-instruction').textContent = 'Conversation completed. Prepare your response.';
                    setTimeout(() => startPreparationPhase(), 2000);
                });
            }, 1000);
            
            // Listening timer
            let timeLeft = 70;
            updateTimerDisplay(timeLeft);
            const listeningTimer = setInterval(() => {
                timeLeft--;
                updateTimerDisplay(timeLeft);
                if (timeLeft <= 0) {
                    clearInterval(listeningTimer);
                }
            }, 1000);
        }
        
        function startPreparationPhase() {
            console.log('ðŸ”„ Starting preparation phase');
            updatePhaseIndicator('preparation', 'Preparation Time');
            updateContent(task2Content, 'preparation');
            document.getElementById('record-instruction').textContent = 'Prepare your response';
            
            // Read question again
            setTimeout(() => {
                playAudio(task2Content.question_prompt, 0.9);
            }, 1000);
            
            // Preparation timer
            let timeLeft = 30;
            updateTimerDisplay(timeLeft);
            const prepTimer = setInterval(() => {
                timeLeft--;
                updateTimerDisplay(timeLeft);
                if (timeLeft <= 0) {
                    clearInterval(prepTimer);
                    startResponsePhase();
                }
            }, 1000);
        }
        
        function startResponsePhase() {
            console.log('ðŸŽ¤ Starting response phase');
            updatePhaseIndicator('response', 'Response Time');
            updateContent(task2Content, 'response');
            updateRecordButton(true, false);
            
            // Auto-start recording
            setTimeout(() => {
                if (mediaRecorder && mediaRecorder.state === 'inactive') {
                    recordedChunks = [];
                    mediaRecorder.start();
                    isRecording = true;
                    updateRecordButton(true, true);
                    updateFixStatus('fix4-status', true);
                }
            }, 1000);
            
            // Response timer
            let timeLeft = 60;
            updateTimerDisplay(timeLeft);
            const responseTimer = setInterval(() => {
                timeLeft--;
                updateTimerDisplay(timeLeft);
                if (timeLeft <= 0) {
                    clearInterval(responseTimer);
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                        isRecording = false;
                    }
                    updateRecordButton(false);
                    document.getElementById('record-instruction').textContent = 'Task 2 completed!';
                }
            }, 1000);
        }
        
        function playConversationWithTwoVoices(conversationText, onComplete) {
            if (!speechSynthesis) {
                alert('Speech synthesis not supported in this browser');
                return;
            }
            
            speechSynthesis.cancel();
            
            // Parse conversation into speaker parts
            const lines = conversationText.split('\n').filter(line => line.trim());
            let currentSpeakerIndex = 0;
            
            // Get available voices
            const voices = speechSynthesis.getVoices();
            
            // Find female and male voices
            const femaleVoice = voices.find(voice => 
                voice.name.includes('Karen') || 
                voice.name.includes('Samantha') ||
                voice.name.includes('Victoria') ||
                voice.name.includes('Susan') ||
                (voice.name.includes('Female') && voice.lang.startsWith('en')) ||
                (voice.gender === 'female' && voice.lang.startsWith('en'))
            ) || voices.find(voice => voice.lang.startsWith('en-US'));
            
            const maleVoice = voices.find(voice => 
                voice.name.includes('Daniel') || 
                voice.name.includes('Alex') ||
                voice.name.includes('David') ||
                voice.name.includes('Tom') ||
                (voice.name.includes('Male') && voice.lang.startsWith('en')) ||
                (voice.gender === 'male' && voice.lang.startsWith('en'))
            ) || voices.find(voice => voice.lang.startsWith('en-US') && voice !== femaleVoice);
            
            console.log("ðŸŽ­ Using voices - Female:", femaleVoice?.name, "Male:", maleVoice?.name);
            
            function speakNextLine(lineIndex) {
                if (lineIndex >= lines.length) {
                    console.log("ðŸ”Š Conversation completed with two voices");
                    if (onComplete) onComplete();
                    return;
                }
                
                const line = lines[lineIndex].trim();
                if (!line) {
                    speakNextLine(lineIndex + 1);
                    return;
                }
                
                // Determine speaker based on line content
                let voice = femaleVoice;
                let speakerName = '';
                
                if (line.includes('Female Student:') || line.includes('Woman:') || line.includes('Female:')) {
                    voice = femaleVoice;
                    speakerName = 'Female Student';
                } else if (line.includes('Male Student:') || line.includes('Man:') || line.includes('Male:')) {
                    voice = maleVoice;
                    speakerName = 'Male Student';
                } else {
                    // If no explicit speaker, alternate between voices
                    voice = (currentSpeakerIndex % 2 === 0) ? femaleVoice : maleVoice;
                    speakerName = (currentSpeakerIndex % 2 === 0) ? 'Female Student' : 'Male Student';
                    currentSpeakerIndex++;
                }
                
                // Clean the text (remove speaker labels)
                let cleanText = line
                    .replace(/^(Female Student:|Male Student:|Woman:|Man:|Female:|Male:)\s*/, '')
                    .trim();
                
                if (!cleanText) {
                    speakNextLine(lineIndex + 1);
                    return;
                }
                
                const utterance = new SpeechSynthesisUtterance(cleanText);
                utterance.voice = voice;
                utterance.rate = 0.85;
                utterance.pitch = voice === femaleVoice ? 1.1 : 0.9; // Different pitch for each speaker
                utterance.volume = 0.9;
                
                // Update UI to show current speaker
                const recordInstructionElement = document.getElementById('record-instruction');
                if (recordInstructionElement) {
                    recordInstructionElement.textContent = `ðŸ”Š ${speakerName}: "${cleanText.substring(0, 40)}${cleanText.length > 40 ? '...' : ''}"`;
                }
                
                utterance.onend = () => {
                    console.log(`ðŸ”Š Completed: ${speakerName}`);
                    setTimeout(() => {
                        speakNextLine(lineIndex + 1);
                    }, 500); // Pause between speakers
                };
                
                utterance.onerror = (event) => {
                    console.error("ðŸ”Š Speech error:", event.error);
                    speakNextLine(lineIndex + 1);
                };
                
                console.log(`ðŸ”Š Speaking as ${speakerName}:`, cleanText.substring(0, 50) + "...");
                speechSynthesis.speak(utterance);
            }
            
            // Start the conversation
            speakNextLine(0);
        }
        
        function testConversationNarration() {
            console.log('ðŸ”Š Testing conversation narration with two voices');
            updateContent(task2Content, 'listening');
            playConversationWithTwoVoices(task2Content.listening_script, () => {
                updateFixStatus('fix2-status', true);
                alert('Conversation narration test completed with two distinct voices!');
            });
        }
        
        function testQuestionReading() {
            console.log('ðŸ”Š Testing question reading');
            playAudio(task2Content.question_prompt, 0.9, () => {
                updateFixStatus('fix3-status', true);
                alert('Question reading test completed!');
            });
        }
        
        async function testRecording() {
            console.log('ðŸŽ¤ Testing recording');
            const recordingReady = await initializeRecording();
            if (!recordingReady) {
                alert('Recording initialization failed');
                return;
            }
            
            updateRecordButton(true, false);
            
            setTimeout(() => {
                if (mediaRecorder && mediaRecorder.state === 'inactive') {
                    recordedChunks = [];
                    mediaRecorder.start();
                    isRecording = true;
                    updateRecordButton(true, true);
                    
                    setTimeout(() => {
                        if (mediaRecorder && mediaRecorder.state === 'recording') {
                            mediaRecorder.stop();
                            isRecording = false;
                            updateRecordButton(false);
                            updateFixStatus('fix4-status', true);
                            updateFixStatus('fix5-status', true);
                            alert('Recording test completed! Check console for details.');
                        }
                    }, 3000);
                }
            }, 1000);
        }
        
        // Add click handler for record button
        document.getElementById('record-btn').addEventListener('click', function() {
            if (mediaRecorder) {
                if (isRecording) {
                    mediaRecorder.stop();
                    isRecording = false;
                    updateRecordButton(true, false);
                } else if (mediaRecorder.state === 'inactive') {
                    recordedChunks = [];
                    mediaRecorder.start();
                    isRecording = true;
                    updateRecordButton(true, true);
                }
            }
        });
    </script>
</body>
</html> 