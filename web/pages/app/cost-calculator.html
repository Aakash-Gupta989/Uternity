<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>University Cost Calculator - UTERNITY</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #f8fafc; }
        .header-container { position: relative; z-index: 50; padding: 1rem; }
        .header-nav { background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); border-radius: 24px; padding: 1rem 1.5rem; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 10px 15px -3px rgba(0,0,0,.1); }
        .nav-link { color: rgba(255,255,255,.85); font-weight: 500; padding: 10px 14px; border-radius: 12px; transition: all .2s ease; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; }
        .nav-link:hover { color: #fff; background: rgba(255,255,255,.15); }
        .nav-link.active { color: #fff; background: rgba(255,255,255,.25); font-weight: 600; }

        .section-title { background: linear-gradient(135deg, #8b5cf6, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; }
        .card { background: #fff; border-radius: 16px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,.08); margin-bottom: 1.5rem; }
        .input { width: 100%; padding: 12px 14px; border: 2px solid #e5e7eb; border-radius: 12px; transition: all .2s ease; }
        .input:focus { outline: none; border-color: #8b5cf6; box-shadow: 0 0 0 3px rgba(139,92,246,.1); }
        .btn-primary { background: linear-gradient(135deg, #8b5cf6, #ec4899); color: #fff; padding: 16px 24px; border-radius: 12px; font-weight: 700; border: none; cursor: pointer; transition: all .2s ease; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 12px 28px rgba(139,92,246,.28); }
        .btn-primary:disabled { background: #9ca3af; cursor: not-allowed; transform: none; }
        
        /* University Search */
        .search-container { position: relative; }
        .search-input { padding-left: 2.5rem; }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #8b5cf6; z-index: 10; }
        .suggestions { 
            position: absolute; 
            top: 100%; 
            left: 0; 
            right: 0; 
            background: white; 
            border: 1px solid #e5e7eb; 
            border-radius: 12px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.15); 
            max-height: 300px; 
            overflow-y: auto; 
            z-index: 1000; 
            display: none;
            margin-top: 4px;
        }
        .suggestions.show { display: block; }
        .suggestion { 
            padding: 12px 16px; 
            cursor: pointer; 
            border-bottom: 1px solid #f3f4f6; 
            transition: background 0.2s; 
        }
        .suggestion:hover, .suggestion.highlighted { background: #f8fafc; }
        .suggestion:last-child { border-bottom: none; }
        .suggestion-name { font-weight: 600; color: #1f2937; }
        .suggestion-details { font-size: 0.875rem; color: #6b7280; margin-top: 2px; }
        .suggestion-rank { background: #8b5cf6; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-right: 8px; }
        
        /* Selected Universities */
        .selected-universities { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin: 1.5rem 0; }
        .university-card { background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 1rem; position: relative; }
        .university-card.selected { border-color: #8b5cf6; background: linear-gradient(135deg, #f3f4ff, #faf5ff); }
        .university-name { font-weight: 600; color: #1f2937; margin-bottom: 0.5rem; }
        .university-info { font-size: 0.875rem; color: #6b7280; }
        .remove-btn { position: absolute; top: 8px; right: 8px; background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; cursor: pointer; }
        
        /* Results */
        .results { display: none; margin-top: 2rem; }
        .results.show { display: block; }
        .cost-table { background: white; border-radius: 12px; overflow: hidden; }
        .table-header { background: linear-gradient(135deg, #8b5cf6, #ec4899); color: white; padding: 1rem; text-align: center; font-weight: 700; }
        .cost-row { display: flex; justify-content: space-between; padding: 0.75rem 1rem; border-bottom: 1px solid #f1f5f9; }
        .cost-row:last-child { border-bottom: none; }
        .cost-label { font-weight: 600; }
        .cost-value { font-weight: 700; color: #1f2937; }
        .cost-total { background: #f8fafc; font-size: 1.1rem; }
        .cost-aid { color: #10b981; }
        
        .debug { position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 8px; font-size: 12px; max-width: 300px; }
    </style>
</head>
<body>
    <div id="header-container"></div>
    
    <main class="px-6 py-8">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="section-title text-5xl mb-4">University Cost Calculator</h1>
                <p class="text-gray-600 text-lg">Calculate and compare university costs with smart suggestions</p>
            </div>

            <!-- University Search -->
            <div class="card">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fas fa-search text-purple-600 mr-2"></i>
                    Search Universities
                </h2>
                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="input search-input" id="university-search" 
                           placeholder="Type university name (e.g., MIT, Stanford, Carnegie Mellon)..." 
                           autocomplete="off">
                    <div class="suggestions" id="suggestions"></div>
                </div>
                <p class="text-sm text-gray-500 mt-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    Start typing to see suggestions. Press Enter to add the first match, or click any suggestion.
                </p>
            </div>

            <!-- Selected Universities -->
            <div id="selected-section" style="display: none;">
                <div class="card">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-university text-purple-600 mr-2"></i>
                        Selected Universities
                    </h3>
                    <div class="selected-universities" id="selected-universities"></div>
                </div>
            </div>

            <!-- Settings -->
            <div class="card">
                <h3 class="text-lg font-bold mb-4 flex items-center">
                    <i class="fas fa-cog text-purple-600 mr-2"></i>
                    Calculation Settings
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Residency Status</label>
                        <select class="input" id="residency-status">
                            <option value="international">International Student</option>
                            <option value="out_state">Out-of-State</option>
                            <option value="in_state">In-State</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Housing Type</label>
                        <select class="input" id="housing-type">
                            <option value="on_campus">On-Campus Housing</option>
                            <option value="off_campus">Off-Campus Housing</option>
                            <option value="commuter">Commuter (No Housing)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Family Income (Optional)</label>
                        <input type="number" class="input" id="family-income" 
                               placeholder="Annual income for aid estimation" min="0" step="1000">
                    </div>
                </div>
            </div>

            <!-- Calculate Button -->
            <div class="text-center">
                <button class="btn-primary" id="calculate-btn" onclick="calculateCosts()" disabled>
                    <i class="fas fa-calculator mr-2"></i>
                    <span id="btn-text">Select Universities to Calculate</span>
                </button>
            </div>

            <!-- Results -->
            <div class="results" id="results">
                <div class="cost-table" id="results-content">
                    <!-- Results will be populated here -->
                </div>
                
                <!-- Charts Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                    <!-- Cost Breakdown Chart -->
                    <div class="card">
                        <h3 class="text-lg font-bold mb-4 flex items-center">
                            <i class="fas fa-chart-pie text-purple-600 mr-2"></i>
                            Cost Breakdown
                        </h3>
                        <canvas id="cost-pie-chart" width="400" height="300"></canvas>
                    </div>
                    
                    <!-- Comparison Chart -->
                    <div class="card" id="comparison-chart-section">
                        <h3 class="text-lg font-bold mb-4 flex items-center">
                            <i class="fas fa-chart-bar text-purple-600 mr-2"></i>
                            University Comparison
                        </h3>
                        <canvas id="comparison-chart" width="400" height="300"></canvas>
                    </div>
                </div>

                <!-- AI-Powered Insights -->
                <div class="card mt-6" id="insights-section">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-lightbulb text-purple-600 mr-2"></i>
                        Smart Insights & Recommendations
                    </h3>
                    <div id="insights-content">
                        <!-- Insights will be populated here -->
                    </div>
                </div>

                <!-- Value Analysis -->
                <div class="card mt-6" id="value-analysis-section">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-trophy text-purple-600 mr-2"></i>
                        Value Analysis & Final Recommendation
                    </h3>
                    <div id="value-analysis-content">
                        <!-- Value analysis will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Debug Panel -->
    <div class="debug" id="debug">
        Status: Loading...
    </div>

    <script>
        console.log('🔧 Cost Calculator Script Starting...');
        
        // Build header identical to university recommender
        document.getElementById('header-container').innerHTML = `
            <header class="header-container">
                <nav class="header-nav">
                    <div class="flex items-center space-x-2">
                        <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center shadow-lg">
                            <svg class="w-6 h-6 text-purple-600" viewBox="0 0 24 24" fill="none">
                                <path d="M12 4L4 8L12 12L20 8L12 4Z" stroke="currentColor" stroke-width="2"/>
                                <path d="M4 12L12 16L20 12" stroke="currentColor" stroke-width="2"/>
                                <path d="M4 16L12 20L20 16" stroke="currentColor" stroke-width="2"/>
                            </svg>
                        </div>
                        <span class="text-2xl font-bold text-white">UTERNITY</span>
                    </div>
                    <div class="flex items-center space-x-6">
                        <a href="chat.html" class="nav-link text-white">
                            <i class="fas fa-comments mr-2"></i>
                            Chat
                        </a>
                        <a href="sop-create.html" class="nav-link text-white">
                            <i class="fas fa-file-alt mr-2"></i>
                            SOP
                        </a>
                        <a href="cost-calculator.html" class="nav-link text-white active">
                            <i class="fas fa-calculator mr-2"></i>
                            Cost Calculator
                        </a>
                        <a href="university-recommender.html" class="nav-link text-white">
                            <i class="fas fa-university mr-2"></i>
                            Recommend
                        </a>
                        <a href="voice-dashboard.html" class="nav-link text-white">
                            <i class="fas fa-graduation-cap mr-2"></i>
                            TOEFL/IELTS
                        </a>
                    </div>
                    <div class="flex items-center space-x-4">
                        
                        <!-- User Menu -->
                        <div class="relative user-menu">
                            <button id="userMenuButton" class="flex items-center space-x-2 p-2 hover:bg-white hover:bg-opacity-10 rounded-lg transition-colors">
                                <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                    <span id="userInitial" class="text-sm font-semibold text-white">?</span>
                                </div>
                                <span id="userDisplayName" class="text-white font-medium hidden sm:block"></span>
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </button>
                            <div id="userDropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-lg py-2 hidden" style="z-index: 9999;">
                                <div class="px-4 py-2 border-b border-gray-100">
                                    <p id="userDropdownName" class="text-sm font-medium text-gray-800"></p>
                                    <p id="userEmail" class="text-xs text-gray-500 mt-1"></p>
                                </div>
                                <a href="/profile" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                    </svg>
                                    Profile
                                </a>
                                <button id="logoutButton" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                                    </svg>
                                    Sign Out
                                </button>
                            </div>
                        </div>
                    </div>
                </nav>
            </header>
        `;

        // Setup header dropdown functionality
        setupHeaderDropdowns();

        console.log('✅ Header built');

        // Setup header dropdown functionality
        function setupHeaderDropdowns() {
            const userMenuButton = document.getElementById('userMenuButton');
            const userDropdown = document.getElementById('userDropdown');
            const logoutButton = document.getElementById('logoutButton');

            if (userMenuButton && userDropdown) {
                // Toggle dropdown on button click
                userMenuButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (userDropdown.style.display === 'none' || userDropdown.style.display === '') {
                        userDropdown.style.display = 'block';
                    } else {
                        userDropdown.style.display = 'none';
                    }
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!userMenuButton.contains(e.target) && !userDropdown.contains(e.target)) {
                        userDropdown.style.display = 'none';
                    }
                });

                // Prevent dropdown from closing when clicking inside it
                userDropdown.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }

            // Populate user initials across header
            (function populateHeaderUserInfo(){
                try {
                    const raw = localStorage.getItem('uternity_user') || localStorage.getItem('user_data');
                    let user = {}; if (raw) { try { user = JSON.parse(raw); } catch { user = {}; } }
                    const name = user.name || user.full_name || user.fullName || user.username || '';
                    const email = user.email || user.user_email || '';
                    function initials(n,e){
                        if(n&&n.trim()){const p=n.trim().split(/\s+/).filter(Boolean);const f=p[0]?.[0]||'';const l=p.length>1?p[p.length-1][0]:'';return((f+l)||'?').toUpperCase();}
                        if(e&&e.trim()){const u=(e.split('@')[0]||'');const t=u.split(/[^a-zA-Z]+/).filter(Boolean);const f=t[0]?.[0]||'';const l=t.length>1?t[t.length-1][0]:'';return((f+l)||u[0]||'?').toUpperCase();}
                        return'?';
                    }
                    const init=initials(name,email);
                    const elI=document.getElementById('userInitial');
                    const elD=document.getElementById('userDisplayName');
                    const elDN=document.getElementById('userDropdownName');
                    const elE=document.getElementById('userEmail');
                    if(elI) elI.textContent=init;
                    if(elD){elD.textContent=''; elD.style.display='none';}
                    if(elDN) elDN.textContent=name||'';
                    if(elE) elE.textContent=email||'';
                } catch(e){ console.warn('populateHeaderUserInfo failed:', e); }
            })();

            // Logout functionality - UPDATED TO CLEAR ALL AUTH DATA
            if (logoutButton) {
                logoutButton.addEventListener('click', async function() {
                    if (confirm('Are you sure you want to sign out?')) {
                        console.log('🚪 Starting logout process from cost calculator page');
                        try {
                            // Try to call our auth service logout endpoint
                            const accessToken = localStorage.getItem('uternity_access_token') || localStorage.getItem('access_token');
                            if (accessToken) {
                                try {
                                    await fetch('http://localhost:8001/auth/logout', {
                                        method: 'POST',
                                        headers: {
                                            'Authorization': `Bearer ${accessToken}`,
                                            'Content-Type': 'application/json'
                                        }
                                    });
                                    console.log('✅ Auth service logout successful from cost calculator page');
                                } catch (error) {
                                    console.warn('⚠️ Auth service logout failed from cost calculator page, continuing with local cleanup:', error);
                                }
                            }

                            // Clear all authentication and session data
                            const keys = [
                                'access_token','refresh_token','session_id','user_data',
                                'uternity_user','uternity_access_token','uternity_refresh_token',
                                'uternity_current_session_id','uternity_token'
                            ];
                            keys.forEach(k => localStorage.removeItem(k));
                            
                            console.log('✅ All local storage cleared from cost calculator page');
                            window.location.href = '/auth/login';
                        } catch (error) {
                            console.error('❌ Logout failed from cost calculator page:', error);
                            // Even if logout fails, clear local data and redirect
                            localStorage.clear();
                            window.location.href = '/auth/login';
                        }
                    }
                });
            }
        }

        // University data - complete list
        const UNIVERSITIES = [
            { name: "Massachusetts Institute of Technology", rank: 1, location: "Cambridge, MA" },
            { name: "Carnegie Mellon University", rank: 2, location: "Pittsburgh, PA" },
            { name: "Stanford University", rank: 3, location: "Stanford, CA" },
            { name: "University of California Berkeley", rank: 4, location: "Berkeley, CA" },
            { name: "Georgia Institute of Technology", rank: 5, location: "Atlanta, GA" },
            { name: "University of Washington", rank: 6, location: "Seattle, WA" },
            { name: "Princeton University", rank: 7, location: "Princeton, NJ" },
            { name: "Harvard University", rank: 8, location: "Cambridge, MA" },
            { name: "California Institute of Technology", rank: 9, location: "Pasadena, CA" },
            { name: "Cornell University", rank: 10, location: "Ithaca, NY" },
            { name: "University of Illinois Urbana Champaign", rank: 11, location: "Urbana, IL" },
            { name: "University of Michigan Ann Arbor", rank: 12, location: "Ann Arbor, MI" },
            { name: "University of Texas at Austin", rank: 13, location: "Austin, TX" },
            { name: "Columbia University", rank: 14, location: "New York, NY" },
            { name: "University of California Los Angeles", rank: 15, location: "Los Angeles, CA" },
            { name: "University of California San Diego", rank: 16, location: "San Diego, CA" },
            { name: "University of Wisconsin Madison", rank: 17, location: "Madison, WI" },
            { name: "Yale University", rank: 18, location: "New Haven, CT" },
            { name: "University of Maryland College Park", rank: 19, location: "College Park, MD" },
            { name: "University of Pennsylvania", rank: 20, location: "Philadelphia, PA" },
            { name: "Purdue University", rank: 21, location: "West Lafayette, IN" },
            { name: "Rice University", rank: 22, location: "Houston, TX" },
            { name: "Duke University", rank: 23, location: "Durham, NC" },
            { name: "University of Southern California", rank: 24, location: "Los Angeles, CA" },
            { name: "Brown University", rank: 25, location: "Providence, RI" },
            { name: "Northwestern University", rank: 26, location: "Evanston, IL" },
            { name: "University of California Irvine", rank: 27, location: "Irvine, CA" },
            { name: "New York University", rank: 28, location: "New York, NY" },
            { name: "Virginia Tech", rank: 29, location: "Blacksburg, VA" },
            { name: "University of Minnesota Twin Cities", rank: 30, location: "Minneapolis, MN" },
            { name: "Ohio State University", rank: 31, location: "Columbus, OH" },
            { name: "University of North Carolina Chapel Hill", rank: 32, location: "Chapel Hill, NC" },
            { name: "Pennsylvania State University", rank: 33, location: "University Park, PA" },
            { name: "University of California Davis", rank: 34, location: "Davis, CA" },
            { name: "University of Florida", rank: 35, location: "Gainesville, FL" },
            { name: "University of Virginia", rank: 36, location: "Charlottesville, VA" },
            { name: "Arizona State University", rank: 37, location: "Tempe, AZ" },
            { name: "Boston University", rank: 38, location: "Boston, MA" },
            { name: "Northeastern University", rank: 39, location: "Boston, MA" },
            { name: "University of Rochester", rank: 40, location: "Rochester, NY" },
            { name: "Michigan State University", rank: 41, location: "East Lansing, MI" },
            { name: "University of Colorado Boulder", rank: 42, location: "Boulder, CO" },
            { name: "University of California Santa Barbara", rank: 43, location: "Santa Barbara, CA" },
            { name: "Johns Hopkins University", rank: 44, location: "Baltimore, MD" },
            { name: "University of Utah", rank: 45, location: "Salt Lake City, UT" }
        ];

        // Global variables
        let selectedUniversities = [];
        let highlightedIndex = -1;

        function updateDebug(message) {
            const debug = document.getElementById('debug');
            if (debug) {
                debug.textContent = message;
            }
            console.log('🔧 DEBUG:', message);
        }

        // University search functionality
        function setupSearch() {
            console.log('🔧 Setting up search...');
            updateDebug('Setting up search functionality...');
            
            const searchInput = document.getElementById('university-search');
            const suggestions = document.getElementById('suggestions');
            
            if (!searchInput || !suggestions) {
                console.error('❌ Search elements not found!');
                updateDebug('ERROR: Search elements not found');
                return;
            }
            
            console.log('✅ Search elements found');
            updateDebug('Search elements found. Ready to type!');
            
            searchInput.addEventListener('input', function() {
                const query = this.value.trim();
                console.log('🔍 Search input:', query);
                updateDebug(`Searching for: "${query}"`);
                
                if (query.length < 1) {
                    suggestions.classList.remove('show');
                    updateDebug('Query too short, hiding suggestions');
                    return;
                }
                
                searchUniversities(query);
            });
            
            searchInput.addEventListener('blur', function() {
                setTimeout(() => {
                    suggestions.classList.remove('show');
                    updateDebug('Search lost focus, hiding suggestions');
                }, 200);
            });

            // Keyboard navigation
            searchInput.addEventListener('keydown', function(e) {
                const suggestionItems = document.querySelectorAll('#suggestions .suggestion');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    highlightedIndex = Math.min(highlightedIndex + 1, suggestionItems.length - 1);
                    updateHighlight(suggestionItems);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    highlightedIndex = Math.max(highlightedIndex - 1, -1);
                    updateHighlight(suggestionItems);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (highlightedIndex >= 0 && suggestionItems[highlightedIndex]) {
                        suggestionItems[highlightedIndex].click();
                    } else if (suggestionItems.length > 0) {
                        // Add first suggestion if none highlighted
                        suggestionItems[0].click();
                    }
                } else if (e.key === 'Escape') {
                    suggestions.classList.remove('show');
                    highlightedIndex = -1;
                }
            });
            
            console.log('✅ Search setup complete');
        }

        function updateHighlight(items) {
            items.forEach((item, index) => {
                item.classList.toggle('highlighted', index === highlightedIndex);
            });
        }

        function searchUniversities(query) {
            console.log('🔍 Searching for:', query);
            const queryLower = query.toLowerCase();
            
            // Client-side filtering for instant results
            const results = UNIVERSITIES.filter(uni => {
                const nameLower = uni.name.toLowerCase();
                return nameLower.includes(queryLower) || 
                       nameLower.split(' ').some(word => word.startsWith(queryLower));
            }).slice(0, 8);
            
            console.log('✅ Found results:', results.length);
            updateDebug(`Found ${results.length} matches for "${query}"`);
            
            displaySuggestions(results);
        }

        function displaySuggestions(results) {
            const suggestions = document.getElementById('suggestions');
            
            if (results.length === 0) {
                suggestions.classList.remove('show');
                updateDebug('No results found');
                return;
            }
            
            console.log('📋 Displaying suggestions:', results);
            
            suggestions.innerHTML = results.map((uni, index) => `
                <div class="suggestion" data-name="${uni.name}" data-rank="${uni.rank}" data-location="${uni.location}">
                    <div class="suggestion-name">${uni.name}</div>
                    <div class="suggestion-details">
                        <span class="suggestion-rank">#${uni.rank}</span>
                        ${uni.location}
                    </div>
                </div>
            `).join('');
            
            // Add click handlers
            suggestions.querySelectorAll('.suggestion').forEach((item, index) => {
                item.addEventListener('click', () => {
                    const name = item.dataset.name;
                    const rank = parseInt(item.dataset.rank);
                    const location = item.dataset.location;
                    console.log('🎯 Clicked suggestion:', name);
                    selectUniversity(name, rank, location);
                });
            });
            
            suggestions.classList.add('show');
            highlightedIndex = -1; // Reset highlight
            updateDebug(`Showing ${results.length} suggestions`);
        }

        function selectUniversity(name, rank, location) {
            console.log('🎯 Selecting university:', name);
            updateDebug(`Adding: ${name}`);
            
            // Check if already selected
            if (selectedUniversities.find(u => u.name === name)) {
                alert('This university is already selected.');
                updateDebug('University already selected');
                return;
            }
            
            // Add to selected list
            selectedUniversities.push({ name, rank, location });
            
            // Clear search
            document.getElementById('university-search').value = '';
            document.getElementById('suggestions').classList.remove('show');
            
            // Update display
            updateSelectedUniversities();
            updateCalculateButton();
            
            console.log('✅ University added. Total selected:', selectedUniversities.length);
            updateDebug(`Added ${name}. Total: ${selectedUniversities.length}`);
        }

        function removeUniversity(index) {
            console.log('🗑️ Removing university at index:', index);
            selectedUniversities.splice(index, 1);
            updateSelectedUniversities();
            updateCalculateButton();
            updateDebug(`Removed university. Total: ${selectedUniversities.length}`);
        }

        function updateSelectedUniversities() {
            const container = document.getElementById('selected-universities');
            const section = document.getElementById('selected-section');
            
            if (selectedUniversities.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            
            container.innerHTML = selectedUniversities.map((uni, index) => `
                <div class="university-card selected">
                    <button class="remove-btn" onclick="removeUniversity(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="university-name">${uni.name}</div>
                    <div class="university-info">
                        Rank: #${uni.rank} | ${uni.location}
                    </div>
                </div>
            `).join('');
        }

        function updateCalculateButton() {
            const btn = document.getElementById('calculate-btn');
            const btnText = document.getElementById('btn-text');
            
            if (selectedUniversities.length === 0) {
                btn.disabled = true;
                btnText.textContent = 'Select Universities to Calculate';
            } else if (selectedUniversities.length === 1) {
                btn.disabled = false;
                btnText.textContent = `Calculate ${selectedUniversities[0].name.split(' ').slice(0, 2).join(' ')} Costs`;
            } else {
                btn.disabled = false;
                btnText.textContent = `Compare ${selectedUniversities.length} Universities`;
            }
            
            console.log('🔄 Button updated:', btnText.textContent);
        }

        function calculateCosts() {
            if (selectedUniversities.length === 0) return;
            
            console.log('💰 Calculating costs for:', selectedUniversities.map(u => u.name));
            
            const btn = document.getElementById('calculate-btn');
            const btnText = document.getElementById('btn-text');
            const originalText = btnText.textContent;
            
            // Show loading
            btn.disabled = true;
            btnText.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Calculating...';
            updateDebug('Calculating costs...');
            
            // Mock calculation with realistic data
            setTimeout(() => {
                const mockResults = selectedUniversities.map(uni => {
                    // Generate realistic costs based on ranking and location
                    let baseTuition = 45000;
                    if (uni.rank <= 10) baseTuition = 65000;
                    else if (uni.rank <= 25) baseTuition = 58000;
                    else if (uni.rank <= 50) baseTuition = 52000;
                    
                    const locationMultiplier = (uni.location.includes('CA') || uni.location.includes('NY') || uni.location.includes('MA')) ? 1.25 : 1.0;
                    
                    const tuition = Math.round(baseTuition * locationMultiplier);
                    const housing = Math.round(15000 * locationMultiplier);
                    const books = 1500;
                    const personal = Math.round(3000 * locationMultiplier);
                    const insurance = 2000;
                    const total = tuition + housing + books + personal + insurance;
                    const aid = Math.round(total * 0.25); // 25% average aid
                    const net = total - aid;
                    
                    return {
                        university_name: uni.name,
                        rank: uni.rank,
                        location: uni.location,
                        tuition: tuition,
                        housing: housing,
                        books_supplies: books,
                        personal_expenses: personal,
                        health_insurance: insurance,
                        total_annual_cost: total,
                        financial_aid: aid,
                        net_annual_cost: net,
                        four_year_cost: Math.round(net * 4.2)
                    };
                });
                
                displayResults(mockResults);
                updateDebug(`Calculated costs for ${mockResults.length} universities`);
                
                // Restore button
                btn.disabled = false;
                btnText.textContent = originalText;
            }, 1500);
        }

        function displayResults(comparisons) {
            console.log('📊 Displaying results for:', comparisons.map(c => c.university_name));
            
            const results = document.getElementById('results');
            const content = document.getElementById('results-content');
            
            if (comparisons.length === 1) {
                // Single university result
                const calc = comparisons[0];
                content.innerHTML = `
                    <div class="table-header">${calc.university_name} - Cost Analysis</div>
                    <div class="p-4">
                        <div class="cost-row">
                            <span class="cost-label">University Ranking</span>
                            <span class="cost-value">#${calc.rank}</span>
                        </div>
                        <div class="cost-row">
                            <span class="cost-label">Location</span>
                            <span class="cost-value">${calc.location}</span>
                        </div>
                        <div class="cost-row">
                            <span class="cost-label">Annual Tuition</span>
                            <span class="cost-value">$${calc.tuition.toLocaleString()}</span>
                        </div>
                        <div class="cost-row">
                            <span class="cost-label">Housing & Meals</span>
                            <span class="cost-value">$${calc.housing.toLocaleString()}</span>
                        </div>
                        <div class="cost-row">
                            <span class="cost-label">Books & Supplies</span>
                            <span class="cost-value">$${calc.books_supplies.toLocaleString()}</span>
                        </div>
                        <div class="cost-row">
                            <span class="cost-label">Personal Expenses</span>
                            <span class="cost-value">$${calc.personal_expenses.toLocaleString()}</span>
                        </div>
                        <div class="cost-row">
                            <span class="cost-label">Health Insurance</span>
                            <span class="cost-value">$${calc.health_insurance.toLocaleString()}</span>
                        </div>
                        <div class="cost-row cost-total">
                            <span class="cost-label">Total Annual Cost</span>
                            <span class="cost-value">$${calc.total_annual_cost.toLocaleString()}</span>
                        </div>
                        <div class="cost-row">
                            <span class="cost-label">Estimated Financial Aid</span>
                            <span class="cost-value cost-aid">-$${calc.financial_aid.toLocaleString()}</span>
                        </div>
                        <div class="cost-row cost-total">
                            <span class="cost-label">Net Annual Cost</span>
                            <span class="cost-value">$${calc.net_annual_cost.toLocaleString()}</span>
                        </div>
                        <div class="cost-row">
                            <span class="cost-label">4-Year Total (with inflation)</span>
                            <span class="cost-value">$${calc.four_year_cost.toLocaleString()}</span>
                        </div>
                    </div>
                `;
            } else {
                // Multiple university comparison
                content.innerHTML = `
                    <div class="table-header">University Cost Comparison</div>
                    <div class="p-4 overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b-2">
                                    <th class="text-left py-2">Cost Category</th>
                                    ${comparisons.map(c => `<th class="text-center py-2">${c.university_name.split(' ').slice(0,2).join(' ')}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="border-b">
                                    <td class="py-2 font-semibold">Ranking</td>
                                    ${comparisons.map(c => `<td class="text-center py-2">#${c.rank}</td>`).join('')}
                                </tr>
                                <tr class="border-b">
                                    <td class="py-2 font-semibold">Tuition</td>
                                    ${comparisons.map(c => `<td class="text-center py-2">$${c.tuition.toLocaleString()}</td>`).join('')}
                                </tr>
                                <tr class="border-b">
                                    <td class="py-2 font-semibold">Housing</td>
                                    ${comparisons.map(c => `<td class="text-center py-2">$${c.housing.toLocaleString()}</td>`).join('')}
                                </tr>
                                <tr class="border-b">
                                    <td class="py-2 font-semibold">Other Costs</td>
                                    ${comparisons.map(c => `<td class="text-center py-2">$${(c.books_supplies + c.personal_expenses + c.health_insurance).toLocaleString()}</td>`).join('')}
                                </tr>
                                <tr class="border-b bg-gray-50">
                                    <td class="py-2 font-bold">Total Annual</td>
                                    ${comparisons.map(c => `<td class="text-center py-2 font-bold">$${c.total_annual_cost.toLocaleString()}</td>`).join('')}
                                </tr>
                                <tr class="border-b">
                                    <td class="py-2 font-semibold">Financial Aid</td>
                                    ${comparisons.map(c => `<td class="text-center py-2 text-green-600">-$${c.financial_aid.toLocaleString()}</td>`).join('')}
                                </tr>
                                <tr class="bg-blue-50">
                                    <td class="py-2 font-bold">Net Annual Cost</td>
                                    ${comparisons.map(c => `<td class="text-center py-2 font-bold text-blue-600">$${c.net_annual_cost.toLocaleString()}</td>`).join('')}
                                </tr>
                                <tr class="border-b">
                                    <td class="py-2 font-semibold">4-Year Total</td>
                                    ${comparisons.map(c => `<td class="text-center py-2">$${c.four_year_cost.toLocaleString()}</td>`).join('')}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            results.classList.add('show');
            createChart(comparisons);
            generateInsights(comparisons);
            generateValueAnalysis(comparisons);
            
            // Scroll to results
            results.scrollIntoView({ behavior: 'smooth' });
        }

        function generateInsights(comparisons) {
            const insightsContent = document.getElementById('insights-content');
            
            if (comparisons.length === 1) {
                const calc = comparisons[0];
                const costBreakdown = getCostBreakdown(calc);
                
                insightsContent.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                            <h4 class="font-bold text-blue-800 mb-2"><i class="fas fa-chart-pie mr-2"></i>Cost Distribution</h4>
                            <p class="text-blue-700 text-sm">
                                <strong>Tuition (${costBreakdown.tuition}%)</strong> is your largest expense. 
                                ${costBreakdown.tuition > 70 ? 'This is quite high - look for merit scholarships!' : 
                                  costBreakdown.tuition > 50 ? 'This is typical for most universities.' : 
                                  'Great! Lower tuition means more budget flexibility.'}
                            </p>
                        </div>
                        
                        <div class="p-4 bg-green-50 rounded-lg border-l-4 border-green-500">
                            <h4 class="font-bold text-green-800 mb-2"><i class="fas fa-dollar-sign mr-2"></i>Financial Aid Impact</h4>
                            <p class="text-green-700 text-sm">
                                With estimated aid of <strong>$${calc.financial_aid.toLocaleString()}</strong>, 
                                you save <strong>${Math.round((calc.financial_aid / calc.total_annual_cost) * 100)}%</strong> annually.
                                ${calc.financial_aid > 20000 ? 'Excellent aid package!' : 
                                  calc.financial_aid > 10000 ? 'Good aid potential.' : 
                                  'Consider applying for external scholarships.'}
                            </p>
                        </div>
                        
                        <div class="p-4 bg-purple-50 rounded-lg border-l-4 border-purple-500">
                            <h4 class="font-bold text-purple-800 mb-2"><i class="fas fa-trophy mr-2"></i>University Ranking</h4>
                            <p class="text-purple-700 text-sm">
                                Ranked <strong>#${calc.rank}</strong> nationally. 
                                ${calc.rank <= 10 ? 'Elite tier university with exceptional opportunities and networking.' :
                                  calc.rank <= 25 ? 'Top-tier university with excellent academic reputation.' :
                                  calc.rank <= 50 ? 'High-quality university with strong programs.' :
                                  'Solid university with good value for education.'}
                            </p>
                        </div>
                        
                        <div class="p-4 bg-yellow-50 rounded-lg border-l-4 border-yellow-500">
                            <h4 class="font-bold text-yellow-800 mb-2"><i class="fas fa-map-marker-alt mr-2"></i>Location Advantage</h4>
                            <p class="text-yellow-700 text-sm">
                                Located in <strong>${calc.location}</strong>. 
                                ${getLocationInsight(calc.location)}
                            </p>
                        </div>
                    </div>
                    
                    <div class="mt-6 p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg border border-indigo-200">
                        <h4 class="font-bold text-indigo-800 mb-3"><i class="fas fa-lightbulb mr-2"></i>Key Insights for ${calc.university_name}</h4>
                        <ul class="space-y-2 text-indigo-700">
                            <li><i class="fas fa-check-circle text-indigo-500 mr-2"></i><strong>Total Investment:</strong> Your 4-year education will cost approximately $${calc.four_year_cost.toLocaleString()}</li>
                            <li><i class="fas fa-check-circle text-indigo-500 mr-2"></i><strong>Monthly Budget:</strong> You'll need about $${Math.round(calc.net_annual_cost / 12).toLocaleString()} per month</li>
                            <li><i class="fas fa-check-circle text-indigo-500 mr-2"></i><strong>ROI Potential:</strong> ${getRankingROI(calc.rank)}</li>
                            <li><i class="fas fa-check-circle text-indigo-500 mr-2"></i><strong>Hidden Costs:</strong> ${getHiddenCostsWarning(calc.location)}</li>
                        </ul>
                    </div>
                `;
            } else {
                // Multiple universities insights
                const cheapest = comparisons.reduce((min, curr) => curr.net_annual_cost < min.net_annual_cost ? curr : min);
                const mostExpensive = comparisons.reduce((max, curr) => curr.net_annual_cost > max.net_annual_cost ? curr : max);
                const bestRanked = comparisons.reduce((best, curr) => curr.rank < best.rank ? curr : best);
                const bestValue = comparisons.reduce((best, curr) => {
                    const currValue = (1000 - curr.rank) / (curr.net_annual_cost / 1000);
                    const bestValueScore = (1000 - best.rank) / (best.net_annual_cost / 1000);
                    return currValue > bestValueScore ? curr : best;
                });
                
                insightsContent.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="p-4 bg-green-50 rounded-lg border-l-4 border-green-500">
                            <h4 class="font-bold text-green-800 mb-2"><i class="fas fa-dollar-sign mr-2"></i>Most Affordable</h4>
                            <p class="text-green-700"><strong>${cheapest.university_name}</strong></p>
                            <p class="text-green-600 text-sm">Net cost: $${cheapest.net_annual_cost.toLocaleString()}/year</p>
                            <p class="text-green-700 text-sm mt-2">${getAffordabilityInsight(cheapest, comparisons)}</p>
                        </div>
                        
                        <div class="p-4 bg-purple-50 rounded-lg border-l-4 border-purple-500">
                            <h4 class="font-bold text-purple-800 mb-2"><i class="fas fa-trophy mr-2"></i>Highest Ranked</h4>
                            <p class="text-purple-700"><strong>${bestRanked.university_name}</strong></p>
                            <p class="text-purple-600 text-sm">Ranking: #${bestRanked.rank}</p>
                            <p class="text-purple-700 text-sm mt-2">${getRankingInsight(bestRanked, comparisons)}</p>
                        </div>
                        
                        <div class="p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                            <h4 class="font-bold text-blue-800 mb-2"><i class="fas fa-star mr-2"></i>Best Value</h4>
                            <p class="text-blue-700"><strong>${bestValue.university_name}</strong></p>
                            <p class="text-blue-600 text-sm">Rank #${bestValue.rank} for $${bestValue.net_annual_cost.toLocaleString()}/year</p>
                            <p class="text-blue-700 text-sm mt-2">${getValueInsight(bestValue, comparisons)}</p>
                        </div>
                        
                        <div class="p-4 bg-orange-50 rounded-lg border-l-4 border-orange-500">
                            <h4 class="font-bold text-orange-800 mb-2"><i class="fas fa-exclamation-triangle mr-2"></i>Cost Difference</h4>
                            <p class="text-orange-700">Range: $${(mostExpensive.net_annual_cost - cheapest.net_annual_cost).toLocaleString()}</p>
                            <p class="text-orange-600 text-sm">From $${cheapest.net_annual_cost.toLocaleString()} to $${mostExpensive.net_annual_cost.toLocaleString()}</p>
                            <p class="text-orange-700 text-sm mt-2">${getCostDifferenceInsight(cheapest, mostExpensive)}</p>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg border border-indigo-200">
                        <h4 class="font-bold text-indigo-800 mb-3"><i class="fas fa-brain mr-2"></i>Detailed Comparison Insights</h4>
                        <div class="space-y-3">
                            ${generateDetailedComparison(comparisons)}
                        </div>
                    </div>
                `;
            }
        }

        function generateValueAnalysis(comparisons) {
            const valueContent = document.getElementById('value-analysis-content');
            
            if (comparisons.length === 1) {
                const calc = comparisons[0];
                const recommendation = getSingleUniversityRecommendation(calc);
                
                valueContent.innerHTML = `
                    <div class="p-6 bg-gradient-to-r from-purple-100 to-pink-100 rounded-lg border-2 border-purple-300">
                        <h4 class="text-xl font-bold text-purple-800 mb-4"><i class="fas fa-graduation-cap mr-2"></i>Final Recommendation for ${calc.university_name}</h4>
                        <div class="text-purple-700 space-y-3">
                            ${recommendation}
                        </div>
                        
                        <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="text-center p-4 bg-white rounded-lg shadow-sm">
                                <div class="text-2xl font-bold text-purple-600">${getAffordabilityScore(calc)}/10</div>
                                <div class="text-sm text-gray-600">Affordability Score</div>
                            </div>
                            <div class="text-center p-4 bg-white rounded-lg shadow-sm">
                                <div class="text-2xl font-bold text-blue-600">${getQualityScore(calc)}/10</div>
                                <div class="text-sm text-gray-600">Academic Quality</div>
                            </div>
                            <div class="text-center p-4 bg-white rounded-lg shadow-sm">
                                <div class="text-2xl font-bold text-green-600">${getValueScore(calc)}/10</div>
                                <div class="text-sm text-gray-600">Overall Value</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                const recommendation = getMultiUniversityRecommendation(comparisons);
                
                valueContent.innerHTML = `
                    <div class="p-6 bg-gradient-to-r from-purple-100 to-pink-100 rounded-lg border-2 border-purple-300">
                        <h4 class="text-xl font-bold text-purple-800 mb-4"><i class="fas fa-medal mr-2"></i>Final Recommendation</h4>
                        <div class="text-purple-700 space-y-3">
                            ${recommendation}
                        </div>
                        
                        <div class="mt-6">
                            <h5 class="font-bold text-purple-800 mb-3">University Rankings Summary:</h5>
                            <div class="grid grid-cols-1 gap-3">
                                ${comparisons.map((calc, index) => `
                                    <div class="flex items-center justify-between p-3 bg-white rounded-lg shadow-sm">
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-full flex items-center justify-center text-sm font-bold">${index + 1}</div>
                                            <div>
                                                <div class="font-semibold">${calc.university_name.split(' ').slice(0, 3).join(' ')}</div>
                                                <div class="text-sm text-gray-600">Rank #${calc.rank} • ${calc.location}</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-bold text-lg">${getValueScore(calc)}/10</div>
                                            <div class="text-sm text-gray-600">Value Score</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Helper functions for insights
        function getCostBreakdown(calc) {
            const total = calc.total_annual_cost;
            return {
                tuition: Math.round((calc.tuition / total) * 100),
                housing: Math.round((calc.housing / total) * 100),
                other: Math.round(((calc.books_supplies + calc.personal_expenses + calc.health_insurance) / total) * 100)
            };
        }

        function getLocationInsight(location) {
            if (location.includes('CA')) {
                return 'California offers great weather, tech industry connections, but higher living costs.';
            } else if (location.includes('NY')) {
                return 'New York provides incredible internship opportunities and cultural experiences.';
            } else if (location.includes('MA')) {
                return 'Massachusetts is the education hub with many prestigious universities nearby.';
            } else if (location.includes('TX')) {
                return 'Texas offers lower cost of living and a growing tech scene.';
            } else if (location.includes('WA')) {
                return 'Washington state has strong tech industry presence, especially in Seattle.';
            } else {
                return 'Consider the local job market and internship opportunities in this area.';
            }
        }

        function getRankingROI(rank) {
            if (rank <= 10) {
                return 'Exceptional ROI - graduates typically earn 20-30% more than average';
            } else if (rank <= 25) {
                return 'Excellent ROI - strong alumni network and career prospects';
            } else if (rank <= 50) {
                return 'Good ROI - solid career outcomes and industry recognition';
            } else {
                return 'Moderate ROI - focus on building skills and networking';
            }
        }

        function getHiddenCostsWarning(location) {
            if (location.includes('CA') || location.includes('NY')) {
                return 'Budget extra $3-5k annually for higher local costs (food, transportation, entertainment)';
            } else if (location.includes('TX') || location.includes('FL')) {
                return 'Budget extra $1-2k annually for transportation and occasional travel home';
            } else {
                return 'Budget extra $2-3k annually for miscellaneous expenses and travel';
            }
        }

        function getAffordabilityInsight(cheapest, comparisons) {
            const savings = comparisons.reduce((max, curr) => curr.net_annual_cost > max ? curr.net_annual_cost : max, 0) - cheapest.net_annual_cost;
            return `Save $${savings.toLocaleString()} annually compared to the most expensive option. Over 4 years, that's $${(savings * 4).toLocaleString()} in savings!`;
        }

        function getRankingInsight(bestRanked, comparisons) {
            const costPremium = bestRanked.net_annual_cost - Math.min(...comparisons.map(c => c.net_annual_cost));
            if (costPremium === 0) {
                return 'Best of both worlds - highest ranking at the lowest cost!';
            } else {
                return `Premium of $${costPremium.toLocaleString()}/year for top ranking. Consider if the prestige and opportunities justify the extra cost.`;
            }
        }

        function getValueInsight(bestValue, comparisons) {
            return `Offers the best balance of academic quality and cost. Strong ranking (#${bestValue.rank}) at a reasonable price point makes this an excellent choice.`;
        }

        function getCostDifferenceInsight(cheapest, mostExpensive) {
            const difference = mostExpensive.net_annual_cost - cheapest.net_annual_cost;
            const fourYearDiff = difference * 4;
            return `The most expensive option costs $${fourYearDiff.toLocaleString()} more over 4 years. Consider if the additional benefits justify this investment.`;
        }

        function generateDetailedComparison(comparisons) {
            const insights = [];
            
            comparisons.forEach((calc, index) => {
                const others = comparisons.filter((_, i) => i !== index);
                const advantages = [];
                const disadvantages = [];
                
                // Compare ranking
                const betterRanked = others.filter(c => c.rank > calc.rank).length;
                if (betterRanked === others.length) {
                    advantages.push(`Highest academic ranking (#${calc.rank})`);
                } else if (betterRanked > 0) {
                    advantages.push(`Better ranking than ${betterRanked} other${betterRanked > 1 ? 's' : ''}`);
                }
                
                // Compare costs
                const moreCostly = others.filter(c => c.net_annual_cost > calc.net_annual_cost).length;
                if (moreCostly === others.length) {
                    advantages.push(`Most affordable option`);
                } else if (moreCostly > 0) {
                    advantages.push(`More affordable than ${moreCostly} other${moreCostly > 1 ? 's' : ''}`);
                }
                
                // Location advantages
                if (calc.location.includes('CA')) {
                    advantages.push('Access to Silicon Valley tech ecosystem');
                } else if (calc.location.includes('NY')) {
                    advantages.push('NYC internship and job opportunities');
                } else if (calc.location.includes('MA')) {
                    advantages.push('Boston academic and biotech hub');
                }
                
                // Disadvantages
                if (others.some(c => c.rank < calc.rank)) {
                    const betterRankedCount = others.filter(c => c.rank < calc.rank).length;
                    disadvantages.push(`${betterRankedCount} other${betterRankedCount > 1 ? 's have' : ' has'} better ranking`);
                }
                
                if (others.some(c => c.net_annual_cost < calc.net_annual_cost)) {
                    const cheaperCount = others.filter(c => c.net_annual_cost < calc.net_annual_cost).length;
                    disadvantages.push(`${cheaperCount} other${cheaperCount > 1 ? 's are' : ' is'} more affordable`);
                }
                
                insights.push(`
                    <div class="p-4 border border-gray-200 rounded-lg">
                        <h5 class="font-bold text-gray-800 mb-2">${calc.university_name}</h5>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h6 class="font-semibold text-green-700 mb-1"><i class="fas fa-plus-circle mr-1"></i>Advantages:</h6>
                                <ul class="text-sm text-green-600 space-y-1">
                                    ${advantages.map(adv => `<li>• ${adv}</li>`).join('')}
                                </ul>
                            </div>
                            <div>
                                <h6 class="font-semibold text-orange-700 mb-1"><i class="fas fa-minus-circle mr-1"></i>Considerations:</h6>
                                <ul class="text-sm text-orange-600 space-y-1">
                                    ${disadvantages.length > 0 ? disadvantages.map(dis => `<li>• ${dis}</li>`).join('') : '<li>• No significant disadvantages compared to others</li>'}
                                </ul>
                            </div>
                        </div>
                    </div>
                `);
            });
            
            return insights.join('');
        }

        function getSingleUniversityRecommendation(calc) {
            const affordabilityScore = getAffordabilityScore(calc);
            const qualityScore = getQualityScore(calc);
            const valueScore = getValueScore(calc);
            
            let recommendation = '';
            
            if (valueScore >= 8) {
                recommendation = `<p><strong>🌟 Highly Recommended!</strong> ${calc.university_name} offers exceptional value with its combination of academic excellence and reasonable costs.</p>`;
            } else if (valueScore >= 6) {
                recommendation = `<p><strong>👍 Good Choice!</strong> ${calc.university_name} provides solid value, though you might want to explore financial aid options.</p>`;
            } else {
                recommendation = `<p><strong>⚠️ Consider Carefully!</strong> While ${calc.university_name} has merit, explore other options or focus heavily on scholarships.</p>`;
            }
            
            if (calc.rank <= 10 && affordabilityScore < 6) {
                recommendation += `<p><strong>Elite University Strategy:</strong> This is a top-tier institution. The high cost may be justified by exceptional career opportunities and lifetime earning potential.</p>`;
            }
            
            if (affordabilityScore >= 8) {
                recommendation += `<p><strong>Financial Advantage:</strong> This university offers excellent affordability. You'll graduate with minimal debt, giving you more career flexibility.</p>`;
            }
            
            return recommendation;
        }

        function getMultiUniversityRecommendation(comparisons) {
            const bestValue = comparisons.reduce((best, curr) => {
                const currValue = (1000 - curr.rank) / (curr.net_annual_cost / 1000);
                const bestValueScore = (1000 - best.rank) / (best.net_annual_cost / 1000);
                return currValue > bestValueScore ? curr : best;
            });
            
            const cheapest = comparisons.reduce((min, curr) => curr.net_annual_cost < min.net_annual_cost ? curr : min);
            const bestRanked = comparisons.reduce((best, curr) => curr.rank < best.rank ? curr : best);
            
            let recommendation = `<p><strong>🎯 Our Top Recommendation: ${bestValue.university_name}</strong></p>`;
            recommendation += `<p>This university offers the best balance of academic quality (rank #${bestValue.rank}) and cost ($${bestValue.net_annual_cost.toLocaleString()}/year).</p>`;
            
            if (bestValue.university_name !== cheapest.university_name) {
                recommendation += `<p><strong>💰 Budget-Conscious Alternative:</strong> Consider ${cheapest.university_name} if cost is your primary concern. You'll save $${(bestValue.net_annual_cost - cheapest.net_annual_cost).toLocaleString()} annually.</p>`;
            }
            
            if (bestValue.university_name !== bestRanked.university_name) {
                recommendation += `<p><strong>🏆 Prestige Option:</strong> ${bestRanked.university_name} has the highest ranking (#${bestRanked.rank}) but costs $${(bestRanked.net_annual_cost - bestValue.net_annual_cost).toLocaleString()} more per year.</p>`;
            }
            
            // Decision framework
            recommendation += `<p><strong>💡 Decision Framework:</strong></p>`;
            recommendation += `<p>• Choose <strong>${cheapest.university_name}</strong> if minimizing debt is your top priority</p>`;
            recommendation += `<p>• Choose <strong>${bestRanked.university_name}</strong> if you want maximum prestige and can afford the cost</p>`;
            recommendation += `<p>• Choose <strong>${bestValue.university_name}</strong> for the best overall balance of quality and value</p>`;
            
            return recommendation;
        }

        // Scoring functions
        function getAffordabilityScore(calc) {
            if (calc.net_annual_cost < 30000) return 10;
            if (calc.net_annual_cost < 40000) return 8;
            if (calc.net_annual_cost < 50000) return 6;
            if (calc.net_annual_cost < 60000) return 4;
            if (calc.net_annual_cost < 70000) return 2;
            return 1;
        }

        function getQualityScore(calc) {
            if (calc.rank <= 10) return 10;
            if (calc.rank <= 25) return 8;
            if (calc.rank <= 50) return 6;
            if (calc.rank <= 100) return 4;
            return 2;
        }

        function getValueScore(calc) {
            const affordability = getAffordabilityScore(calc);
            const quality = getQualityScore(calc);
            return Math.round((affordability + quality) / 2);
        }

        function createChart(comparisons) {
            createPieChart(comparisons);
            if (comparisons.length > 1) {
                createComparisonChart(comparisons);
                document.getElementById('comparison-chart-section').style.display = 'block';
            } else {
                document.getElementById('comparison-chart-section').style.display = 'none';
            }
        }

        function createPieChart(comparisons) {
            const ctx = document.getElementById('cost-pie-chart').getContext('2d');
            
            if (window.pieChart) {
                window.pieChart.destroy();
            }
            
            // Use first university for pie chart
            const calc = comparisons[0];
            window.pieChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Tuition & Fees', 'Housing & Meals', 'Books & Supplies', 'Personal Expenses', 'Health Insurance'],
                    datasets: [{
                        data: [calc.tuition, calc.housing, calc.books_supplies, calc.personal_expenses, calc.health_insurance],
                        backgroundColor: ['#8b5cf6', '#06b6d4', '#10b981', '#f59e0b', '#ef4444'],
                        borderWidth: 3,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { 
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label;
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: $${value.toLocaleString()} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createComparisonChart(comparisons) {
            const ctx = document.getElementById('comparison-chart').getContext('2d');
            
            if (window.comparisonChart) {
                window.comparisonChart.destroy();
            }
            
            window.comparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: comparisons.map(c => c.university_name.split(' ').slice(0,2).join(' ')),
                    datasets: [{
                        label: 'Net Annual Cost',
                        data: comparisons.map(c => c.net_annual_cost),
                        backgroundColor: ['#8b5cf6', '#06b6d4', '#10b981', '#f59e0b'],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOM Content Loaded - Initializing Cost Calculator...');
            updateDebug('Initializing...');
            
            try {
                setupSearch();
                updateCalculateButton();
                updateDebug('✅ Ready! Try typing "MIT" or "Arizona"');
                console.log('✅ Cost Calculator ready!');
            } catch (error) {
                console.error('❌ Initialization error:', error);
                updateDebug('❌ Error: ' + error.message);
            }
        });
        
        // Test function for debugging
        window.testSearch = function(query) {
            console.log('🧪 Testing search for:', query);
            searchUniversities(query);
        };
        
        console.log('🔧 Script loaded completely');
    </script>
</body>
</html>