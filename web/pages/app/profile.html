<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - UTERNITY</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        /* Header styling to match other pages */
        .header-container {
            position: relative;
            z-index: 50;
            padding: 1rem;
            margin-bottom: 0;
        }

        .header-nav {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            border-radius: 24px;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
            transition: all 0.3s ease;
            padding: 10px 16px;
            border-radius: 12px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-link:hover {
            color: white;
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .nav-link.active {
            color: white;
            background: rgba(255, 255, 255, 0.25);
            font-weight: 600;
        }

        /* Horizontal Progress Bar */
        .horizontal-progress-container {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            padding: 1rem 0;
            margin-bottom: 0;
        }

        .horizontal-progress-bar {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            position: relative;
        }

        .progress-stages {
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            padding: 1rem 0;
        }

        .progress-line {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 3px;
            background: #e5e7eb;
            border-radius: 2px;
            z-index: 1;
        }

        .progress-line-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            border-radius: 2px;
            transition: width 0.8s ease;
            width: 18%; /* Shows progress through stage 2 */
        }

        .progress-stage-horizontal {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 0.5rem;
            border-radius: 12px;
        }

        .progress-stage-horizontal:hover {
            transform: translateY(-2px);
            background: rgba(139, 92, 246, 0.05);
        }

        .stage-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .stage-circle.completed {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .stage-circle.in-progress {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            animation: pulse-glow 2s infinite;
        }

        .stage-circle.pending {
            background: #f8fafc;
            color: #6b7280;
            border-color: #e5e7eb;
        }

        .stage-circle.pending:hover {
            background: #f1f5f9;
            border-color: #8b5cf6;
            color: #8b5cf6;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
            50% { box-shadow: 0 4px 20px rgba(59, 130, 246, 0.5); }
        }

        .stage-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #374151;
            text-align: center;
            line-height: 1.2;
            max-width: 80px;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        .progress-stage-horizontal:hover .stage-label {
            opacity: 1;
        }

        .stage-label.completed {
            color: #059669;
        }

        .stage-label.in-progress {
            color: #1d4ed8;
        }

        /* Tooltip */
        .stage-tooltip {
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .stage-tooltip::before {
            content: '';
            position: absolute;
            top: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-bottom: 4px solid #1f2937;
        }

        .progress-stage-horizontal:hover .stage-tooltip {
            opacity: 1;
            bottom: -35px;
        }

        /* Main container - Updated for single column */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            min-height: calc(100vh - 180px);
        }

        /* Profile sidebar - Updated for single column layout */
        .profile-sidebar {
            display: flex;
            flex-direction: row;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }





        /* Progress tracker */
        .progress-tracker {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(226, 232, 240, 0.8);
            overflow: hidden;
        }

        .progress-header {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            padding: 1.5rem;
            font-weight: 600;
            font-size: 1.125rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .progress-content {
            padding: 1.5rem;
        }

        .progress-stage {
            display: flex;
            align-items: center;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
        }

        .progress-stage:hover {
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
            border-color: #8b5cf6;
            transform: translateX(4px);
        }

        .progress-stage.completed {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-color: #10b981;
        }

        .progress-stage.in-progress {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-color: #3b82f6;
        }

        .progress-stage.pending {
            background: #f9fafb;
            border-color: #e5e7eb;
        }

        .stage-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-size: 1rem;
            font-weight: 600;
        }

        .stage-icon.completed {
            background: #10b981;
            color: white;
        }

        .stage-icon.in-progress {
            background: #3b82f6;
            color: white;
        }

        .stage-icon.pending {
            background: #e5e7eb;
            color: #6b7280;
        }

        .stage-content {
            flex: 1;
        }

        .stage-title {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }

        .stage-description {
            font-size: 0.75rem;
            color: #6b7280;
            line-height: 1.4;
        }

        .stage-status {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            margin-left: 1rem;
        }

        .stage-status.completed {
            background: #d1fae5;
            color: #065f46;
        }

        .stage-status.in-progress {
            background: #dbeafe;
            color: #1e40af;
        }

        .stage-status.pending {
            background: #f3f4f6;
            color: #374151;
        }

        /* Main content area */
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* NEW Tab Navigation - Perfect Equal Spacing */
        .profile-tab-navigation {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(226, 232, 240, 0.8);
            padding: 8px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
            gap: 8px;
            align-items: center;
            margin-bottom: 2rem;
        }

        .profile-tab-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px 8px;
            border: none;
            background: transparent;
            border-radius: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #6b7280;
            min-height: 60px;
            text-align: center;
        }

        .profile-tab-btn i {
            font-size: 1.1rem;
            margin-bottom: 4px;
        }

        .profile-tab-btn span {
            line-height: 1.2;
            font-size: 0.75rem;
        }

        .profile-tab-btn.active {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(139, 92, 246, 0.3);
        }

        .profile-tab-btn:hover:not(.active) {
            background: rgba(139, 92, 246, 0.1);
            color: #7c3aed;
        }



        /* Content sections */
        .content-section {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(226, 232, 240, 0.8);
            padding: 2rem;
            display: none;
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Form styling */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            font-weight: 600;
            font-size: 0.875rem;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .form-input {
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        /* Button styling */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
        }

        .btn-secondary {
            background: #f8fafc;
            color: #374151;
            border: 2px solid #e5e7eb;
        }

        .btn-secondary:hover {
            background: #f1f5f9;
            border-color: #d1d5db;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }

        /* University preferences */
        .preference-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .preference-card {
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .preference-card:hover {
            border-color: #8b5cf6;
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
        }

        .preference-card.selected {
            border-color: #8b5cf6;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }

        .preference-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .preference-title {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }

        .preference-desc {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        /* Security section */
        .security-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 12px;
            margin-bottom: 1rem;
        }

        .security-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .security-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .security-details h4 {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }

        .security-details p {
            font-size: 0.75rem;
            color: #6b7280;
        }

        /* Circular Progress Indicator */
        .profile-progress-circle {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .profile-progress-circle:hover {
            transform: scale(1.05);
        }

        .progress-ring {
            position: absolute;
            top: 0;
            left: 0;
            transform: rotate(-90deg);
        }

        .progress-ring-background {
            transition: stroke 0.3s ease;
        }

        .progress-ring-progress {
            transition: stroke-dashoffset 0.8s ease, stroke 0.3s ease;
            animation: progress-pulse 2s infinite;
        }

        @keyframes progress-pulse {
            0%, 100% { 
                stroke: #10b981; 
                filter: drop-shadow(0 0 3px rgba(16, 185, 129, 0.3));
            }
            50% { 
                stroke: #059669; 
                filter: drop-shadow(0 0 6px rgba(16, 185, 129, 0.5));
            }
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.75rem;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            z-index: 2;
        }

        /* Tooltip for progress circle */
        .profile-progress-circle::after {
            content: 'Profile Completion';
            position: absolute;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .profile-progress-circle::before {
            content: '';
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-bottom: 4px solid #1f2937;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .profile-progress-circle:hover::after,
        .profile-progress-circle:hover::before {
            opacity: 1;
        }

        /* Circular Progress Indicator for Tab Navigation */
        .profile-progress-circle-tab {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 45px;
            height: 45px;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
            margin-left: 0.5rem;
        }

        .profile-progress-circle-tab:hover {
            transform: scale(1.05);
        }

        .progress-ring-tab {
            position: absolute;
            top: 0;
            left: 0;
        }

        .progress-ring-background-tab {
            transition: stroke 0.3s ease;
        }

        .progress-ring-progress-tab {
            transition: stroke-dashoffset 0.8s ease, stroke 0.3s ease;
            animation: progress-pulse-tab 2s infinite;
        }

        @keyframes progress-pulse-tab {
            0%, 100% { 
                stroke: #10b981; 
                filter: drop-shadow(0 0 2px rgba(16, 185, 129, 0.3));
            }
            50% { 
                stroke: #059669; 
                filter: drop-shadow(0 0 4px rgba(16, 185, 129, 0.5));
            }
        }

        .progress-text-tab {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.7rem;
            font-weight: 700;
            color: #374151;
            z-index: 2;
        }

        /* Tooltip for tab progress circle */
        .profile-progress-circle-tab::after {
            content: 'Profile Completion';
            position: absolute;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 0.4rem 0.6rem;
            border-radius: 6px;
            font-size: 0.7rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .profile-progress-circle-tab::before {
            content: '';
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-bottom: 4px solid #1f2937;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .profile-progress-circle-tab:hover::after,
        .profile-progress-circle-tab:hover::before {
            opacity: 1;
        }

        /* Responsive design */
        @media (max-width: 1024px) {
            .horizontal-progress-bar {
                padding: 0 1rem;
            }

            .progress-stages {
                flex-wrap: wrap;
                gap: 0.5rem;
                justify-content: center;
            }

            .progress-line {
                display: none; /* Hide connecting line on mobile */
            }

            .stage-circle {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }

            .stage-label {
                font-size: 0.625rem;
                max-width: 60px;
            }

            .main-container {
                padding: 1rem;
            }

            .profile-sidebar {
                flex-direction: column;
                gap: 1rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .tab-navigation {
                flex-wrap: wrap;
                justify-content: center;
            }

            .tab-button {
                flex: none;
                min-width: calc(50% - 0.25rem);
            }

            .profile-progress-circle-tab {
                width: 40px;
                height: 40px;
                margin: 0.5rem auto 0;
                order: 10; /* Move to end on mobile */
            }

            .progress-ring-tab {
                width: 40px;
                height: 40px;
            }

            .progress-ring-tab circle {
                r: 16;
                cx: 20;
                cy: 20;
            }

            .progress-text-tab {
                font-size: 0.65rem;
            }
            .preference-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loading states */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #f3f4f6;
            border-radius: 50%;
            border-top-color: #8b5cf6;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Success/Error messages */
        .message {
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div id="header-container"></div>

    <!-- Horizontal Progress Bar -->
    <div class="horizontal-progress-container">
        <div class="horizontal-progress-bar">
            <div class="progress-stages">
                <!-- Progress Line -->
                <div class="progress-line">
                    <div class="progress-line-fill"></div>
                </div>

                <!-- Stage 1: University Research -->
                <div class="progress-stage-horizontal" data-stage="research">
                    <div class="stage-circle completed">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="stage-label completed">Research</div>
                    <div class="stage-tooltip">University Research & Selection</div>
                </div>

                <!-- Stage 2: Standardized Testing -->
                <div class="progress-stage-horizontal" data-stage="testing">
                    <div class="stage-circle in-progress">
                        <i class="fas fa-pencil-alt"></i>
                    </div>
                    <div class="stage-label in-progress">Testing</div>
                    <div class="stage-tooltip">TOEFL/IELTS & GRE/GMAT</div>
                </div>

                <!-- Stage 3: Document Preparation -->
                <div class="progress-stage-horizontal" data-stage="documents">
                    <div class="stage-circle pending">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <div class="stage-label">Documents</div>
                    <div class="stage-tooltip">Transcripts & Academic Records</div>
                </div>

                <!-- Stage 4: SOP & Essays -->
                <div class="progress-stage-horizontal" data-stage="sop">
                    <div class="stage-circle pending">
                        <i class="fas fa-edit"></i>
                    </div>
                    <div class="stage-label">SOP</div>
                    <div class="stage-tooltip">Statement of Purpose & Essays</div>
                </div>

                <!-- Stage 5: Recommendations -->
                <div class="progress-stage-horizontal" data-stage="recommendations">
                    <div class="stage-circle pending">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stage-label">Letters</div>
                    <div class="stage-tooltip">Recommendation Letters</div>
                </div>

                <!-- Stage 6: Application Submission -->
                <div class="progress-stage-horizontal" data-stage="application">
                    <div class="stage-circle pending">
                        <i class="fas fa-paper-plane"></i>
                    </div>
                    <div class="stage-label">Apply</div>
                    <div class="stage-tooltip">Submit Applications</div>
                </div>

                <!-- Stage 7: Admission Decision -->
                <div class="progress-stage-horizontal" data-stage="decision">
                    <div class="stage-circle pending">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stage-label">Decision</div>
                    <div class="stage-tooltip">Admission Results</div>
                </div>

                <!-- Stage 8: Financial Planning -->
                <div class="progress-stage-horizontal" data-stage="financial">
                    <div class="stage-circle pending">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stage-label">Finance</div>
                    <div class="stage-tooltip">Scholarships & I-20</div>
                </div>

                <!-- Stage 9: F1 Visa Process -->
                <div class="progress-stage-horizontal" data-stage="visa">
                    <div class="stage-circle pending">
                        <i class="fas fa-passport"></i>
                    </div>
                    <div class="stage-label">Visa</div>
                    <div class="stage-tooltip">F1 Visa & Interview</div>
                </div>

                <!-- Stage 10: Pre-Departure -->
                <div class="progress-stage-horizontal" data-stage="departure">
                    <div class="stage-circle pending">
                        <i class="fas fa-plane"></i>
                    </div>
                    <div class="stage-label">Travel</div>
                    <div class="stage-tooltip">Pre-Departure Prep</div>
                </div>

                <!-- Stage 11: University Arrival -->
                <div class="progress-stage-horizontal" data-stage="arrival">
                    <div class="stage-circle pending">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div class="stage-label">Arrival</div>
                    <div class="stage-tooltip">Campus & Orientation</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">


        <!-- Main Content -->
        <div class="main-content">
            <!-- Tab Navigation - Rebuilt from scratch -->
            <div class="profile-tab-navigation">
                <button class="profile-tab-btn active" data-tab="personal">
                    <i class="fas fa-user"></i>
                    <span>Personal Info</span>
                </button>
                <button class="profile-tab-btn" data-tab="academic">
                    <i class="fas fa-graduation-cap"></i>
                    <span>Academic Profile</span>
                </button>
                <button class="profile-tab-btn" data-tab="preferences">
                    <i class="fas fa-university"></i>
                    <span>University Preferences</span>
                </button>
                <button class="profile-tab-btn" data-tab="applied">
                    <i class="fas fa-paper-plane"></i>
                    <span>Universities Applied</span>
                </button>
                <button class="profile-tab-btn" data-tab="security">
                    <i class="fas fa-shield-alt"></i>
                    <span>Security</span>
                </button>

            </div>



            <!-- Personal Information Tab -->
            <div class="content-section active" id="personal-tab">
                <div class="section-title">
                    <i class="fas fa-user"></i>
                    Personal Information
                </div>
                
                <form id="personalForm" class="form-grid">
                    <div class="form-group">
                        <label class="form-label">First Name</label>
                        <input type="text" class="form-input" id="firstName" placeholder="Enter your first name">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Last Name</label>
                        <input type="text" class="form-input" id="lastName" placeholder="Enter your last name">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-input" id="email" placeholder="your.email@example.com" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" class="form-input" id="phone" placeholder="+1 (555) 123-4567">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Country</label>
                        <select class="form-input form-select" id="country">
                            <option value="">Select your country</option>
                            <option value="US">United States</option>
                            <option value="CA">Canada</option>
                            <option value="UK">United Kingdom</option>
                            <option value="AU">Australia</option>
                            <option value="IN">India</option>
                            <option value="CN">China</option>
                            <option value="DE">Germany</option>
                            <option value="FR">France</option>
                            <option value="JP">Japan</option>
                            <option value="KR">South Korea</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Date of Birth</label>
                        <input type="date" class="form-input" id="dateOfBirth">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Gender</label>
                        <select class="form-input form-select" id="gender">
                            <option value="">Select gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="other">Other</option>
                            <option value="prefer-not-to-say">Prefer not to say</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">LinkedIn Profile</label>
                        <input type="url" class="form-input" id="linkedinUrl" placeholder="https://linkedin.com/in/yourprofile">
                    </div>
                    
                    <div class="form-group full-width">
                        <label class="form-label">Bio / About Me</label>
                        <textarea class="form-input form-textarea" id="bio" placeholder="Tell us about yourself, your goals, and aspirations..."></textarea>
                    </div>
                </form>
                
                <div style="margin-top: 2rem; display: flex; gap: 1rem;">
                    <button type="button" class="btn btn-primary" onclick="savePersonalInfo()">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="resetPersonalForm()">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                </div>
            </div>

            <!-- Academic Profile Tab -->
            <div class="content-section" id="academic-tab">
                <div class="section-title">
                    <i class="fas fa-graduation-cap"></i>
                    Academic Profile
                </div>
                
                <form id="academicForm" class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Current Education Level</label>
                        <select class="form-input form-select" id="educationLevel">
                            <option value="">Select education level</option>
                            <option value="high-school">High School</option>
                            <option value="bachelors">Bachelor's Degree</option>
                            <option value="masters">Master's Degree</option>
                            <option value="phd">PhD</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Field of Study</label>
                        <input type="text" class="form-input" id="fieldOfStudy" placeholder="e.g., Computer Science, Business">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Target Degree Program</label>
                        <select class="form-input form-select" id="targetDegree">
                            <option value="">Select target degree</option>
                            <option value="bachelors">Bachelor's</option>
                            <option value="masters">Master's</option>
                            <option value="phd">PhD</option>
                            <option value="certificate">Certificate</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">GPA (if applicable)</label>
                        <input type="number" class="form-input" id="gpa" placeholder="3.8" step="0.1" min="0" max="4">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">TOEFL Score</label>
                        <input type="number" class="form-input" id="toeflScore" placeholder="100" min="0" max="120">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">IELTS Score</label>
                        <input type="number" class="form-input" id="ieltsScore" placeholder="7.5" step="0.5" min="0" max="9">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">GRE Score</label>
                        <input type="number" class="form-input" id="greScore" placeholder="320" min="260" max="340">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">GMAT Score</label>
                        <input type="number" class="form-input" id="gmatScore" placeholder="700" min="200" max="800">
                    </div>
                    
                    <div class="form-group full-width">
                        <label class="form-label">Academic Background</label>
                        <textarea class="form-input form-textarea" id="academicBackground" placeholder="Describe your academic achievements, research experience, projects..."></textarea>
                    </div>
                    
                    <div class="form-group full-width">
                        <label class="form-label">Professional Goals</label>
                        <textarea class="form-input form-textarea" id="professionalGoals" placeholder="What are your career aspirations and professional goals?"></textarea>
                    </div>
                </form>
                
                <div style="margin-top: 2rem; display: flex; gap: 1rem;">
                    <button type="button" class="btn btn-primary" onclick="saveAcademicInfo()">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="resetAcademicForm()">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                </div>
            </div>

            <!-- University Preferences Tab -->
            <div class="content-section" id="preferences-tab">
                <div class="section-title">
                    <i class="fas fa-university"></i>
                    University Preferences
                </div>
                
                <div style="margin-bottom: 2rem;">
                    <h3 style="font-weight: 600; margin-bottom: 1rem;">Preferred Countries for Study</h3>
                    <div class="preference-grid" id="countryPreferences">
                        <div class="preference-card" data-value="US">
                            <div class="preference-icon">🇺🇸</div>
                            <div class="preference-title">United States</div>
                            <div class="preference-desc">Top universities, diverse programs</div>
                        </div>
                        <div class="preference-card" data-value="CA">
                            <div class="preference-icon">🇨🇦</div>
                            <div class="preference-title">Canada</div>
                            <div class="preference-desc">Quality education, immigration friendly</div>
                        </div>
                        <div class="preference-card" data-value="UK">
                            <div class="preference-icon">🇬🇧</div>
                            <div class="preference-title">United Kingdom</div>
                            <div class="preference-desc">Historic universities, shorter programs</div>
                        </div>
                        <div class="preference-card" data-value="AU">
                            <div class="preference-icon">🇦🇺</div>
                            <div class="preference-title">Australia</div>
                            <div class="preference-desc">Research opportunities, lifestyle</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 2rem;">
                    <h3 style="font-weight: 600; margin-bottom: 1rem;">Budget Range (Annual)</h3>
                    <div class="preference-grid" id="budgetPreferences">
                        <div class="preference-card" data-value="low">
                            <div class="preference-icon">💰</div>
                            <div class="preference-title">$10,000 - $30,000</div>
                            <div class="preference-desc">Budget-friendly options</div>
                        </div>
                        <div class="preference-card" data-value="medium">
                            <div class="preference-icon">💸</div>
                            <div class="preference-title">$30,000 - $60,000</div>
                            <div class="preference-desc">Mid-range universities</div>
                        </div>
                        <div class="preference-card" data-value="high">
                            <div class="preference-icon">💎</div>
                            <div class="preference-title">$60,000+</div>
                            <div class="preference-desc">Premium institutions</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 2rem;">
                    <h3 style="font-weight: 600; margin-bottom: 1rem;">University Size Preference</h3>
                    <div class="preference-grid" id="sizePreferences">
                        <div class="preference-card" data-value="small">
                            <div class="preference-icon">🏫</div>
                            <div class="preference-title">Small (< 5,000)</div>
                            <div class="preference-desc">Intimate, close-knit community</div>
                        </div>
                        <div class="preference-card" data-value="medium">
                            <div class="preference-icon">🏛️</div>
                            <div class="preference-title">Medium (5,000 - 15,000)</div>
                            <div class="preference-desc">Balanced experience</div>
                        </div>
                        <div class="preference-card" data-value="large">
                            <div class="preference-icon">🏟️</div>
                            <div class="preference-title">Large (15,000+)</div>
                            <div class="preference-desc">Diverse opportunities, resources</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 2rem;">
                    <h3 style="font-weight: 600; margin-bottom: 1rem;">Campus Type</h3>
                    <div class="preference-grid" id="campusPreferences">
                        <div class="preference-card" data-value="urban">
                            <div class="preference-icon">🏙️</div>
                            <div class="preference-title">Urban</div>
                            <div class="preference-desc">City life, internships, networking</div>
                        </div>
                        <div class="preference-card" data-value="suburban">
                            <div class="preference-icon">🏘️</div>
                            <div class="preference-title">Suburban</div>
                            <div class="preference-desc">Balanced environment</div>
                        </div>
                        <div class="preference-card" data-value="rural">
                            <div class="preference-icon">🌲</div>
                            <div class="preference-title">Rural</div>
                            <div class="preference-desc">Peaceful, focused study environment</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 2rem; display: flex; gap: 1rem;">
                    <button type="button" class="btn btn-primary" onclick="savePreferences()">
                        <i class="fas fa-save"></i> Save Preferences
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="resetPreferences()">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                </div>
            </div>

            <!-- Universities Applied Tab -->
            <div class="content-section" id="applied-tab">
                <div class="section-title">
                    <i class="fas fa-paper-plane"></i>
                    Universities Applied
                </div>
                
                <!-- Add University Button -->
                <div style="text-align: center; margin: 3rem 0;">
                    <button id="addUniversityBtn" class="btn btn-primary" style="
                        padding: 1rem 2rem;
                        font-size: 1.1rem;
                        background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
                        border: none;
                        border-radius: 12px;
                        color: white;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3);
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(124, 58, 237, 0.4)';" onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 15px rgba(124, 58, 237, 0.3)';">
                        <i class="fas fa-plus"></i> Add University
                    </button>
                </div>

                <!-- University Cards Container -->
                <div id="universitiesContainer" style="
                    display: grid;
                    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
                    gap: 1.5rem;
                    margin-top: 2rem;
                "></div>

                <!-- Add University Modal -->
                <div id="addUniversityModal" style="
                    display: none;
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.6);
                    z-index: 1000;
                    backdrop-filter: blur(4px);
                ">
                    <div style="
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: white;
                        border-radius: 20px;
                        padding: 2rem;
                        width: 90%;
                        max-width: 500px;
                        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3 style="font-size: 1.25rem; font-weight: 700; color: #1f2937; margin: 0;">
                                <i class="fas fa-university" style="color: #7c3aed; margin-right: 0.5rem;"></i>
                                Add University
                            </h3>
                            <button onclick="closeAddUniversityModal()" style="
                                background: none;
                                border: none;
                                font-size: 1.5rem;
                                color: #6b7280;
                                cursor: pointer;
                                padding: 0.5rem;
                                border-radius: 50%;
                                transition: all 0.3s ease;
                            " onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">
                                ×
                            </button>
                        </div>

                        <form id="universityForm" style="display: flex; flex-direction: column; gap: 1.5rem;">
                            <!-- University Name with Auto-suggest -->
                            <div class="form-group">
                                <label for="universityNameInput" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">
                                    University Name *
                                </label>
                                <div style="position: relative;">
                                    <input 
                                        type="text" 
                                        id="universityNameInput" 
                                        placeholder="Start typing university name..." 
                                        required
                                        style="
                                            width: 100%;
                                            padding: 0.75rem;
                                            border: 2px solid #e5e7eb;
                                            border-radius: 8px;
                                            font-size: 1rem;
                                            transition: all 0.3s ease;
                                        "
                                        onfocus="this.style.borderColor='#7c3aed'"
                                        onblur="this.style.borderColor='#e5e7eb'"
                                        oninput="showUniversitySuggestions(this.value)"
                                    >
                                    <div id="universitySuggestions" style="
                                        position: absolute;
                                        top: 100%;
                                        left: 0;
                                        right: 0;
                                        background: white;
                                        border: 2px solid #e5e7eb;
                                        border-top: none;
                                        border-radius: 0 0 8px 8px;
                                        max-height: 200px;
                                        overflow-y: auto;
                                        display: none;
                                        z-index: 1001;
                                    "></div>
                                </div>
                            </div>

                            <!-- Status Checkboxes -->
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 0.75rem; font-weight: 600; color: #374151;">
                                    Application Status *
                                </label>
                                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border-radius: 8px; transition: all 0.3s ease;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='transparent'">
                                        <input type="radio" name="applicationStatus" value="planning" style="width: 1.25rem; height: 1.25rem; accent-color: #7c3aed;">
                                        <span style="font-weight: 500;">📋 Planning to Apply</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border-radius: 8px; transition: all 0.3s ease;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='transparent'">
                                        <input type="radio" name="applicationStatus" value="applied" style="width: 1.25rem; height: 1.25rem; accent-color: #7c3aed;">
                                        <span style="font-weight: 500;">✅ Already Applied</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border-radius: 8px; transition: all 0.3s ease;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='transparent'">
                                        <input type="radio" name="applicationStatus" value="admitted" style="width: 1.25rem; height: 1.25rem; accent-color: #7c3aed;">
                                        <span style="font-weight: 500;">🎉 Got Admitted</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Application Date (conditional) -->
                            <div class="form-group" id="applicationDateGroup" style="display: none;">
                                <label for="applicationDate" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">
                                    When did you apply?
                                </label>
                                <input 
                                    type="date" 
                                    id="applicationDate"
                                    style="
                                        width: 100%;
                                        padding: 0.75rem;
                                        border: 2px solid #e5e7eb;
                                        border-radius: 8px;
                                        font-size: 1rem;
                                    "
                                >
                            </div>

                            <!-- Admission Date (conditional) -->
                            <div class="form-group" id="admissionDateGroup" style="display: none;">
                                <label for="admissionDate" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">
                                    When did you get admitted?
                                </label>
                                <input 
                                    type="date" 
                                    id="admissionDate"
                                    style="
                                        width: 100%;
                                        padding: 0.75rem;
                                        border: 2px solid #e5e7eb;
                                        border-radius: 8px;
                                        font-size: 1rem;
                                    "
                                >
                            </div>

                            <!-- Notes -->
                            <div class="form-group">
                                <label for="universityNotes" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">
                                    Notes (Optional)
                                </label>
                                <textarea 
                                    id="universityNotes" 
                                    placeholder="Any additional notes..."
                                    rows="3"
                                    style="
                                        width: 100%;
                                        padding: 0.75rem;
                                        border: 2px solid #e5e7eb;
                                        border-radius: 8px;
                                        font-size: 1rem;
                                        resize: vertical;
                                    "
                                ></textarea>
                            </div>

                            <!-- Submit Button -->
                            <button type="submit" style="
                                padding: 0.75rem 1.5rem;
                                background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
                                color: white;
                                border: none;
                                border-radius: 8px;
                                font-weight: 600;
                                cursor: pointer;
                                transition: all 0.3s ease;
                            " onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform=''">
                                <i class="fas fa-plus"></i> Add University
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Security Tab -->
            <div class="content-section" id="security-tab">
                <div class="section-title">
                    <i class="fas fa-shield-alt"></i>
                    Security & Privacy
                </div>
                
                <div class="security-item">
                    <div class="security-info">
                        <div class="security-icon">
                            <i class="fas fa-key"></i>
                        </div>
                        <div class="security-details">
                            <h4>Change Password</h4>
                            <p>Update your password to keep your account secure</p>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="showChangePassword()">
                        <i class="fas fa-edit"></i> Change
                    </button>
                </div>
                
                <div class="security-item">
                    <div class="security-info">
                        <div class="security-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="security-details">
                            <h4>Two-Factor Authentication</h4>
                            <p>Add an extra layer of security to your account</p>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="setup2FA()">
                        <i class="fas fa-plus"></i> Enable
                    </button>
                </div>
                
                <div class="security-item">
                    <div class="security-info">
                        <div class="security-icon">
                            <i class="fas fa-history"></i>
                        </div>
                        <div class="security-details">
                            <h4>Login History</h4>
                            <p>View your recent login activity and active sessions</p>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="viewLoginHistory()">
                        <i class="fas fa-eye"></i> View
                    </button>
                </div>
                
                <div class="security-item">
                    <div class="security-info">
                        <div class="security-icon">
                            <i class="fas fa-download"></i>
                        </div>
                        <div class="security-details">
                            <h4>Export Data</h4>
                            <p>Download a copy of your personal data</p>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="exportData()">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
                
                <div class="security-item" style="border: 2px solid #fee2e2; background: #fef2f2;">
                    <div class="security-info">
                        <div class="security-icon" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                            <i class="fas fa-trash"></i>
                        </div>
                        <div class="security-details">
                            <h4 style="color: #dc2626;">Delete Account</h4>
                            <p style="color: #991b1b;">Permanently delete your account and all associated data</p>
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="deleteAccount()">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let isLoading = false;



        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Initializing Profile Page...');
            loadHeader();
            setupEventListeners();
            loadUserData();
            
            // Initialize universities after a short delay
            setTimeout(() => {
                loadUniversities();
            }, 500);
        });

        // Load header
        function loadHeader() {
            const headerContainer = document.getElementById('header-container');
            headerContainer.innerHTML = `
                <header class="header-container">
                    <nav class="header-nav">
                        <div class="flex items-center space-x-2">
                            <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center shadow-lg">
                                <svg class="w-6 h-6 text-purple-600" viewBox="0 0 24 24" fill="none">
                                    <path d="M12 4L4 8L12 12L20 8L12 4Z" stroke="currentColor" stroke-width="2"/>
                                    <path d="M4 12L12 16L20 12" stroke="currentColor" stroke-width="2"/>
                                    <path d="M4 16L12 20L20 16" stroke="currentColor" stroke-width="2"/>
                                </svg>
                            </div>
                            <span class="text-2xl font-bold text-white">UTERNITY</span>
                        </div>
                        <div class="flex items-center space-x-6">
                            <a href="dashboard.html" class="nav-link text-white">
                                <i class="fas fa-home"></i> Dashboard
                            </a>
                            <a href="chat.html" class="nav-link text-white">
                                <i class="fas fa-comments"></i> Chat
                            </a>
                            <a href="sop-create.html" class="nav-link text-white">
                                <i class="fas fa-file-alt"></i> SOP
                            </a>
                            <a href="cost-calculator.html" class="nav-link text-white">
                                <i class="fas fa-calculator"></i> Cost Calculator
                            </a>
                            <a href="university-recommender.html" class="nav-link text-white">
                                <i class="fas fa-university"></i> Recommend
                            </a>
                            <a href="voice-dashboard.html" class="nav-link text-white">
                                <i class="fas fa-graduation-cap"></i> TOEFL/IELTS
                            </a>
                        </div>
                        <div class="flex items-center space-x-4">
                            
                            <div class="relative user-menu">
                                <button id="userMenuButton" class="w-10 h-10 bg-white bg-opacity-20 rounded-xl flex items-center justify-center text-white hover:bg-opacity-30 transition-all">
                                    <i class="fas fa-user"></i>
                                </button>
                                <div id="userDropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-lg py-2 hidden" style="z-index: 9999;">
                                    <div class="px-4 py-2 border-b border-gray-100">
                                        <p id="userDropdownName" class="text-sm font-medium text-gray-800"></p>
                                        <p id="userEmail" class="text-xs text-gray-500 mt-1"></p>
                                    </div>
                                    <a href="/profile" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                        </svg>
                                        Profile
                                    </a>
                                    <button id="logoutButton" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                                        </svg>
                                        Logout
                                    </button>
                                </div>
                            </div>
                        </div>
                    </nav>
                </header>
            `;
            
            // Setup header dropdowns and progress indicator
            setupHeaderDropdowns();
            updateProfileProgress();
        }

        // Setup header dropdowns
        function setupHeaderDropdowns() {
            const userMenuButton = document.getElementById('userMenuButton');
            const userDropdown = document.getElementById('userDropdown');
            const logoutButton = document.getElementById('logoutButton');

            if (userMenuButton && userDropdown) {
                userMenuButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    userDropdown.classList.toggle('hidden');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!userMenuButton.contains(e.target) && !userDropdown.contains(e.target)) {
                        userDropdown.classList.add('hidden');
                    }
                });
            }

            if (logoutButton) {
                logoutButton.addEventListener('click', () => {
                    localStorage.removeItem('token');
                    window.location.href = '/';
                });
            }
        }

        // Calculate and update profile progress (removed - no progress indicator)
        function updateProfileProgress() {
            // Progress indicator removed from header
            return;
        }

        // Calculate profile completion percentage
        function calculateProfileCompletion() {
            const fields = [
                'firstName', 'lastName', 'email', 'phone', 'country', 'bio',
                'educationLevel', 'fieldOfStudy', 'gpa', 'testScores', 'goals',
                'preferredCountries', 'budget', 'campusType', 'programType'
            ];
            
            let filledFields = 0;
            const totalFields = fields.length;
            
            fields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element && element.value && element.value.trim() !== '') {
                    filledFields++;
                }
            });
            
            // Add some base completion for having an account
            const baseCompletion = 20;
            const fieldCompletion = Math.round((filledFields / totalFields) * 80);
            
            return Math.min(baseCompletion + fieldCompletion, 100);
        }

        // Setup event listeners
        function setupEventListeners() {
            // Tab navigation
            document.querySelectorAll('.profile-tab-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    switchTab(tabId);
                });
            });

            // Horizontal progress stage clicks
            document.querySelectorAll('.progress-stage-horizontal').forEach(stage => {
                stage.addEventListener('click', function() {
                    const stageId = this.dataset.stage;
                    handleStageClick(stageId);
                });
            });

            // Preference cards
            setupPreferenceCards();
        }

        // Switch tabs
        function switchTab(tabId) {
            // Update tab buttons
            document.querySelectorAll('.profile-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');

            // Update content sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(`${tabId}-tab`).classList.add('active');
        }

        // Setup preference cards
        function setupPreferenceCards() {
            document.querySelectorAll('.preference-card').forEach(card => {
                card.addEventListener('click', function() {
                    const group = this.parentElement;
                    const isMultiSelect = group.id === 'countryPreferences';
                    
                    if (isMultiSelect) {
                        // Multiple selection for countries
                        this.classList.toggle('selected');
                    } else {
                        // Single selection for other preferences
                        group.querySelectorAll('.preference-card').forEach(c => c.classList.remove('selected'));
                        this.classList.add('selected');
                    }
                });
            });
        }

        // Handle stage clicks - Enhanced with comprehensive checklists
        function handleStageClick(stageId) {
            console.log('Stage clicked:', stageId);
            showStageChecklist(stageId);
        }

        // Show comprehensive stage checklist with integrated UTERNITY features
        function showStageChecklist(stageId) {
            const stageData = getStageData(stageId);
            if (!stageData) {
                showMessage('This stage will be available soon!', 'info');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'stage-checklist-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                backdrop-filter: blur(4px);
            `;

            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 20px;
                    padding: 0;
                    max-width: 700px;
                    width: 95%;
                    max-height: 90vh;
                    overflow: hidden;
                    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                    animation: modalSlideIn 0.3s ease-out;
                ">
                    <!-- Header -->
                    <div style="
                        background: linear-gradient(135deg, ${stageData.gradient});
                        padding: 2rem;
                        color: white;
                        position: relative;
                    ">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                            <div style="
                                width: 50px;
                                height: 50px;
                                background: rgba(255,255,255,0.2);
                                border-radius: 12px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 1.5rem;
                            ">
                                <i class="${stageData.icon}"></i>
                            </div>
                            <div>
                                <h2 style="font-size: 1.5rem; font-weight: 700; margin: 0;">${stageData.title}</h2>
                                <p style="margin: 0; opacity: 0.9; font-size: 0.95rem;">${stageData.description}</p>
                            </div>
                        </div>
                        <button onclick="this.closest('.stage-checklist-modal').remove()" style="
                            position: absolute;
                            top: 1rem;
                            right: 1rem;
                            background: rgba(255,255,255,0.2);
                            border: none;
                            color: white;
                            width: 40px;
                            height: 40px;
                            border-radius: 50%;
                            cursor: pointer;
                            font-size: 1.2rem;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                            ×
                        </button>
                    </div>

                    <!-- Content -->
                    <div style="padding: 2rem; max-height: 60vh; overflow-y: auto;">
                        <!-- UTERNITY Tools Section -->
                        ${stageData.tools && stageData.tools.length > 0 ? `
                            <div style="margin-bottom: 2rem;">
                                <h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; color: #1f2937; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-rocket" style="color: #7c3aed;"></i>
                                    UTERNITY Tools for This Stage
                                </h3>
                                <div style="display: grid; gap: 0.75rem;">
                                    ${stageData.tools.map(tool => `
                                        <a href="${tool.url}" style="
                                            display: flex;
                                            align-items: center;
                                            gap: 1rem;
                                            padding: 1rem;
                                            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
                                            border: 2px solid #e9d5ff;
                                            border-radius: 12px;
                                            text-decoration: none;
                                            color: #7c3aed;
                                            font-weight: 500;
                                            transition: all 0.3s ease;
                                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(139, 92, 246, 0.2)';" onmouseout="this.style.transform=''; this.style.boxShadow='';">
                                            <i class="${tool.icon}" style="font-size: 1.2rem;"></i>
                                            <div>
                                                <div style="font-weight: 600;">${tool.text}</div>
                                                <div style="font-size: 0.85rem; opacity: 0.7;">${tool.description}</div>
                                            </div>
                                        </a>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <!-- Checklist Section -->
                        <div>
                            <h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; color: #1f2937; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-tasks" style="color: #10b981;"></i>
                                Stage Checklist
                                <span style="font-size: 0.8rem; background: #e5e7eb; color: #6b7280; padding: 0.25rem 0.5rem; border-radius: 6px; font-weight: 500;">
                                    ${getStageProgress(stageId)}% Complete
                                </span>
                            </h3>
                            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                ${stageData.checklist.map((item, index) => `
                                    <div style="
                                        display: flex;
                                        align-items: flex-start;
                                        gap: 0.75rem;
                                        padding: 1rem;
                                        background: ${isChecklistItemCompleted(stageId, index) ? '#f0fdf4' : '#fafafa'};
                                        border: 2px solid ${isChecklistItemCompleted(stageId, index) ? '#bbf7d0' : '#e5e7eb'};
                                        border-radius: 12px;
                                        transition: all 0.3s ease;
                                    ">
                                        <input 
                                            type="checkbox" 
                                            ${isChecklistItemCompleted(stageId, index) ? 'checked' : ''}
                                            onchange="toggleChecklistItem('${stageId}', ${index})"
                                            style="
                                                width: 20px;
                                                height: 20px;
                                                margin-top: 2px;
                                                cursor: pointer;
                                                accent-color: #10b981;
                                            "
                                        />
                                        <div style="flex: 1;">
                                            <div style="
                                                font-weight: 500;
                                                color: #1f2937;
                                                ${isChecklistItemCompleted(stageId, index) ? 'text-decoration: line-through; opacity: 0.7;' : ''}
                                            ">${item.text}</div>
                                            ${item.description ? `
                                                <div style="
                                                    font-size: 0.85rem;
                                                    color: #6b7280;
                                                    margin-top: 0.25rem;
                                                    ${isChecklistItemCompleted(stageId, index) ? 'opacity: 0.5;' : ''}
                                                ">${item.description}</div>
                                            ` : ''}
                                            ${item.action ? `
                                                <button onclick="${item.action}" style="
                                                    margin-top: 0.5rem;
                                                    padding: 0.5rem 1rem;
                                                    background: #7c3aed;
                                                    color: white;
                                                    border: none;
                                                    border-radius: 8px;
                                                    font-size: 0.85rem;
                                                    font-weight: 500;
                                                    cursor: pointer;
                                                    transition: all 0.3s ease;
                                                " onmouseover="this.style.background='#6d28d9'" onmouseout="this.style.background='#7c3aed'">
                                                    ${item.actionText || 'Take Action'}
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Add animation styles
            if (!document.getElementById('modal-animations')) {
                const style = document.createElement('style');
                style.id = 'modal-animations';
                style.textContent = `
                    @keyframes modalSlideIn {
                        from {
                            opacity: 0;
                            transform: scale(0.9) translateY(20px);
                        }
                        to {
                            opacity: 1;
                            transform: scale(1) translateY(0);
                        }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // Show stage modal
        function showStageModal(title, description, actions) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 16px;
                    padding: 2rem;
                    max-width: 500px;
                    width: 90%;
                    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
                ">
                    <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; color: #1f2937;">${title}</h3>
                    <p style="color: #6b7280; margin-bottom: 2rem; line-height: 1.6;">${description}</p>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 2rem;">
                        ${actions.map(action => `
                            <a href="${action.url}" style="
                                display: flex;
                                align-items: center;
                                gap: 0.75rem;
                                padding: 1rem;
                                background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
                                border: 2px solid #e9d5ff;
                                border-radius: 12px;
                                text-decoration: none;
                                color: #7c3aed;
                                font-weight: 500;
                                transition: all 0.3s ease;
                            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(139, 92, 246, 0.2)';" onmouseout="this.style.transform=''; this.style.boxShadow='';">
                                <i class="${action.icon}"></i>
                                ${action.text}
                            </a>
                        `).join('')}
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        width: 100%;
                        padding: 0.75rem;
                        background: #f8fafc;
                        border: 2px solid #e5e7eb;
                        border-radius: 12px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background='#f1f5f9';" onmouseout="this.style.background='#f8fafc';">
                        Close
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close on backdrop click
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Get comprehensive stage data with UTERNITY integrations
        function getStageData(stageId) {
            const stageDataMap = {
                research: {
                    title: 'University Research',
                    description: 'Find and research universities that match your goals and profile',
                    icon: 'fas fa-search',
                    gradient: '#3b82f6 0%, #1d4ed8 100%',
                    tools: [
                        {
                            text: 'University Recommender',
                            description: 'Get AI-powered university recommendations based on your profile',
                            url: '/university',
                            icon: 'fas fa-university'
                        },
                        {
                            text: 'AI Chat Assistant',
                            description: 'Ask questions about universities and admission requirements',
                            url: '/chat',
                            icon: 'fas fa-comments'
                        }
                    ],
                    checklist: [
                        {
                            text: 'Identify your target field of study',
                            description: 'Choose your major/program area based on career goals'
                        },
                        {
                            text: 'Use UTERNITY University Recommender',
                            description: 'Get personalized university recommendations',
                            action: "window.open('/university', '_blank')",
                            actionText: 'Open Recommender'
                        },
                        {
                            text: 'Create a list of 8-12 target universities',
                            description: 'Mix of reach, match, and safety schools'
                        },
                        {
                            text: 'Research admission requirements for each university',
                            description: 'GPA, test scores, essays, deadlines, etc.'
                        },
                        {
                            text: 'Check application deadlines and requirements',
                            description: 'Note early decision, regular decision, and rolling admissions'
                        }
                    ]
                },
                testing: {
                    title: 'Standardized Testing',
                    description: 'Prepare for and complete required standardized tests',
                    icon: 'fas fa-graduation-cap',
                    gradient: '#10b981 0%, #059669 100%',
                    tools: [
                        {
                            text: 'TOEFL/IELTS Practice',
                            description: 'Practice English proficiency tests with AI feedback',
                            url: '/voice-dashboard',
                            icon: 'fas fa-microphone'
                        },
                        {
                            text: 'AI Chat for Test Prep',
                            description: 'Get test preparation strategies and tips',
                            url: '/chat',
                            icon: 'fas fa-comments'
                        }
                    ],
                    checklist: [
                        {
                            text: 'Determine which tests you need (GRE/GMAT/SAT/TOEFL/IELTS)',
                            description: 'Check requirements for each target university'
                        },
                        {
                            text: 'Register for required tests',
                            description: 'Book test dates well in advance'
                        },
                        {
                            text: 'Create a study schedule',
                            description: 'Plan 2-3 months of preparation time'
                        },
                        {
                            text: 'Take practice tests',
                            description: 'Use official practice materials and UTERNITY tools',
                            action: "window.open('/voice-dashboard', '_blank')",
                            actionText: 'Practice TOEFL/IELTS'
                        },
                        {
                            text: 'Take official tests',
                            description: 'Complete all required standardized tests'
                        },
                        {
                            text: 'Send scores to universities',
                            description: 'Use official score reporting services'
                        }
                    ]
                },
                documents: {
                    title: 'Document Preparation',
                    description: 'Gather and prepare all required application documents',
                    icon: 'fas fa-file-alt',
                    gradient: '#f59e0b 0%, #d97706 100%',
                    tools: [
                        {
                            text: 'AI Chat Assistant',
                            description: 'Get help with document requirements and preparation',
                            url: '/chat',
                            icon: 'fas fa-comments'
                        }
                    ],
                    checklist: [
                        {
                            text: 'Order official transcripts',
                            description: 'Request from all institutions attended'
                        },
                        {
                            text: 'Get degree certificates/diplomas',
                            description: 'Obtain certified copies if needed'
                        },
                        {
                            text: 'Prepare financial documents',
                            description: 'Bank statements, sponsor letters, scholarship proof'
                        },
                        {
                            text: 'Check passport validity',
                            description: 'Ensure passport is valid for at least 2 years'
                        },
                        {
                            text: 'Get English proficiency certificates',
                            description: 'TOEFL/IELTS score reports'
                        },
                        {
                            text: 'Prepare resume/CV',
                            description: 'Academic and professional format as required'
                        }
                    ]
                },
                sop: {
                    title: 'SOP & Essays',
                    description: 'Write compelling statements of purpose and application essays',
                    icon: 'fas fa-edit',
                    gradient: '#8b5cf6 0%, #7c3aed 100%',
                    tools: [
                        {
                            text: 'AI Chat for Writing Help',
                            description: 'Get writing tips and feedback on your essays',
                            url: '/chat',
                            icon: 'fas fa-comments'
                        }
                    ],
                    checklist: [
                        {
                            text: 'Research essay requirements for each university',
                            description: 'Word limits, prompts, and specific requirements'
                        },
                        {
                            text: 'Write personal statement/SOP',
                            description: 'Tell your story, goals, and why this program'
                        },
                        {
                            text: 'Write supplemental essays',
                            description: 'Answer university-specific prompts'
                        },
                        {
                            text: 'Get feedback and revise',
                            description: 'Have mentors, professors, or peers review'
                        },
                        {
                            text: 'Final proofreading',
                            description: 'Check grammar, spelling, and formatting'
                        }
                    ]
                },
                recommendations: {
                    title: 'Recommendation Letters',
                    description: 'Secure strong letters of recommendation',
                    icon: 'fas fa-user-friends',
                    gradient: '#ef4444 0%, #dc2626 100%',
                    tools: [
                        {
                            text: 'AI Chat Assistant',
                            description: 'Get advice on approaching recommenders',
                            url: '/chat',
                            icon: 'fas fa-comments'
                        }
                    ],
                    checklist: [
                        {
                            text: 'Identify potential recommenders',
                            description: 'Professors, supervisors, mentors who know you well'
                        },
                        {
                            text: 'Ask recommenders early (2-3 months ahead)',
                            description: 'Give them plenty of time to write quality letters'
                        },
                        {
                            text: 'Provide recommenders with materials',
                            description: 'Resume, SOP, transcript, program details'
                        },
                        {
                            text: 'Send gentle reminders',
                            description: 'Follow up politely as deadlines approach'
                        },
                        {
                            text: 'Confirm submission',
                            description: 'Verify letters were submitted to all universities'
                        }
                    ]
                },
                application: {
                    title: 'Application Submission',
                    description: 'Complete and submit your university applications',
                    icon: 'fas fa-paper-plane',
                    gradient: '#06b6d4 0%, #0891b2 100%',
                    tools: [
                        {
                            text: 'AI Chat Assistant',
                            description: 'Get help with application questions and requirements',
                            url: '/chat',
                            icon: 'fas fa-comments'
                        }
                    ],
                    checklist: [
                        {
                            text: 'Create accounts on application portals',
                            description: 'Common App, university-specific portals, etc.'
                        },
                        {
                            text: 'Fill out application forms',
                            description: 'Personal info, academic history, activities'
                        },
                        {
                            text: 'Upload all required documents',
                            description: 'Transcripts, essays, resume, certificates'
                        },
                        {
                            text: 'Pay application fees',
                            description: 'Submit payment for each application'
                        },
                        {
                            text: 'Submit applications before deadlines',
                            description: 'Allow buffer time for technical issues'
                        }
                    ]
                },
                decision: {
                    title: 'Admission Decisions',
                    description: 'Track applications and make your final university choice',
                    icon: 'fas fa-trophy',
                    gradient: '#f59e0b 0%, #d97706 100%',
                    tools: [
                        {
                            text: 'AI Chat Assistant',
                            description: 'Get advice on choosing between offers',
                            url: '/chat',
                            icon: 'fas fa-comments'
                        }
                    ],
                    checklist: [
                        {
                            text: 'Track application status',
                            description: 'Monitor portals for updates and decisions'
                        },
                        {
                            text: 'Prepare for interviews (if required)',
                            description: 'Practice common questions and research programs'
                        },
                        {
                            text: 'Receive admission decisions',
                            description: 'Wait for acceptance, rejection, or waitlist notifications'
                        },
                        {
                            text: 'Compare offers',
                            description: 'Consider program fit, cost, location, opportunities'
                        },
                        {
                            text: 'Make final university choice',
                            description: 'Select the best option for your goals'
                        }
                    ]
                },
                financial: {
                    title: 'Financial Planning',
                    description: 'Secure funding and manage finances for your education',
                    icon: 'fas fa-dollar-sign',
                    gradient: '#10b981 0%, #059669 100%',
                    tools: [
                        {
                            text: 'AI Chat Assistant',
                            description: 'Get advice on scholarships and financial planning',
                            url: '/chat',
                            icon: 'fas fa-comments'
                        }
                    ],
                    checklist: [
                        {
                            text: 'Research scholarship opportunities',
                            description: 'University, government, and private scholarships'
                        },
                        {
                            text: 'Apply for scholarships',
                            description: 'Submit applications for all eligible scholarships'
                        },
                        {
                            text: 'Explore education loan options',
                            description: 'Compare interest rates and terms from different lenders'
                        },
                        {
                            text: 'Calculate total budget',
                            description: 'Tuition, living costs, travel, insurance, misc expenses'
                        },
                        {
                            text: 'Secure funding sources',
                            description: 'Finalize loans, scholarships, and family support'
                        }
                    ]
                },
                visa: {
                    title: 'Visa Application',
                    description: 'Apply for and obtain your student visa',
                    icon: 'fas fa-passport',
                    gradient: '#8b5cf6 0%, #7c3aed 100%',
                    tools: [
                        {
                            text: 'AI Chat Assistant',
                            description: 'Get help with visa requirements and process',
                            url: '/chat',
                            icon: 'fas fa-comments'
                        }
                    ],
                    checklist: [
                        {
                            text: 'Receive I-20/CAS document from university',
                            description: 'Official document required for visa application'
                        },
                        {
                            text: 'Pay SEVIS fee (for US)',
                            description: 'Required fee for F-1 visa applicants'
                        },
                        {
                            text: 'Complete visa application form',
                            description: 'DS-160 for US, or country-specific forms'
                        },
                        {
                            text: 'Schedule visa interview appointment',
                            description: 'Book at nearest embassy/consulate'
                        },
                        {
                            text: 'Attend visa interview',
                            description: 'Be confident, honest, and well-prepared'
                        }
                    ]
                },
                departure: {
                    title: 'Travel Preparation',
                    description: 'Plan your journey and prepare for departure',
                    icon: 'fas fa-suitcase',
                    gradient: '#06b6d4 0%, #0891b2 100%',
                    tools: [
                        {
                            text: 'AI Chat Assistant',
                            description: 'Get travel tips and preparation advice',
                            url: '/chat',
                            icon: 'fas fa-comments'
                        }
                    ],
                    checklist: [
                        {
                            text: 'Book flight tickets',
                            description: 'Compare prices and book well in advance'
                        },
                        {
                            text: 'Arrange temporary accommodation',
                            description: 'Hotel, university housing, or temporary stay'
                        },
                        {
                            text: 'Get travel insurance',
                            description: 'Coverage for medical emergencies and travel issues'
                        },
                        {
                            text: 'Pack essentials',
                            description: 'Documents, clothes, electronics, medications'
                        },
                        {
                            text: 'Inform university of arrival',
                            description: 'Share flight details and expected arrival time'
                        }
                    ]
                },
                arrival: {
                    title: 'Arrival & Settlement',
                    description: 'Complete arrival formalities and settle into your new environment',
                    icon: 'fas fa-home',
                    gradient: '#ef4444 0%, #dc2626 100%',
                    tools: [
                        {
                            text: 'AI Chat Assistant',
                            description: 'Get help with settling in and local information',
                            url: '/chat',
                            icon: 'fas fa-comments'
                        }
                    ],
                    checklist: [
                        {
                            text: 'Complete immigration process at airport',
                            description: 'Present documents to immigration officers'
                        },
                        {
                            text: 'Register with university',
                            description: 'Complete enrollment and get student ID'
                        },
                        {
                            text: 'Open local bank account',
                            description: 'Needed for local transactions and payments'
                        },
                        {
                            text: 'Get local SIM card/phone plan',
                            description: 'Stay connected with family and university'
                        },
                        {
                            text: 'Attend orientation programs',
                            description: 'Learn about campus, services, and academic requirements'
                        }
                    ]
                }
            };

            return stageDataMap[stageId] || null;
        }

        // Check if checklist item is completed
        function isChecklistItemCompleted(stageId, itemIndex) {
            const checklistData = JSON.parse(localStorage.getItem('uternity_checklist') || '{}');
            return checklistData[stageId] && checklistData[stageId][itemIndex] === true;
        }

        // Toggle checklist item completion
        function toggleChecklistItem(stageId, itemIndex) {
            const checklistData = JSON.parse(localStorage.getItem('uternity_checklist') || '{}');
            
            if (!checklistData[stageId]) {
                checklistData[stageId] = {};
            }
            
            const wasCompleted = checklistData[stageId][itemIndex];
            checklistData[stageId][itemIndex] = !checklistData[stageId][itemIndex];
            localStorage.setItem('uternity_checklist', JSON.stringify(checklistData));
            
            // Check if stage is now fully completed
            const stageData = getStageData(stageId);
            const totalItems = stageData ? stageData.checklist.length : 0;
            const completedItems = Object.values(checklistData[stageId] || {}).filter(Boolean).length;
            const isStageCompleted = completedItems === totalItems;
            
            // Only update progress indicators (profile circle, NOT horizontal bar)
            updateProgressIndicators();
            
            // ONLY update horizontal progress bar when entire stage is completed
            if (isStageCompleted && checklistData[stageId][itemIndex]) {
                updateHorizontalProgressBar();
            }
            
            // Show appropriate notification
            if (checklistData[stageId][itemIndex]) {
                if (isStageCompleted) {
                    showMessage(`🎉 ${stageData.title} stage completed!`, 'success');
                } else {
                    showMessage('✅ Task completed!', 'success');
                }
            }
        }

        // Get stage progress percentage
        function getStageProgress(stageId) {
            const stageData = getStageData(stageId);
            if (!stageData) return 0;
            
            const checklistData = JSON.parse(localStorage.getItem('uternity_checklist') || '{}');
            const stageChecklist = checklistData[stageId] || {};
            
            const totalItems = stageData.checklist.length;
            const completedItems = Object.values(stageChecklist).filter(Boolean).length;
            
            return Math.round((completedItems / totalItems) * 100);
        }

        // Update all progress indicators
        function updateProgressIndicators() {
            // DON'T update horizontal progress bar during individual task completion
            // Only update profile completion circle (which doesn't affect horizontal bar)
            updateProfileProgress();
        }

        // Update horizontal progress bar based on checklist completion
        function updateHorizontalProgressBar() {
            // Don't update if progress bar doesn't exist
            const progressContainer = document.querySelector('.horizontal-progress-container');
            if (!progressContainer) {
                console.log('Progress container not found, skipping update');
                return;
            }

            const stages = ['research', 'testing', 'documents', 'sop', 'recommendations', 'application', 'decision', 'financial', 'visa', 'departure', 'arrival'];
            let completedStages = 0;

            stages.forEach((stageId, index) => {
                const stageProgress = getStageProgress(stageId);
                
                const stageElement = document.querySelector(`[data-stage="${stageId}"]`);
                if (stageElement) {
                    const circle = stageElement.querySelector('.stage-circle');
                    if (circle) {
                        // Get current classes to preserve them
                        const currentClasses = Array.from(circle.classList);
                        const baseClasses = currentClasses.filter(cls => 
                            !['completed', 'in-progress'].includes(cls)
                        );
                        
                        // Clear all classes and re-add base classes
                        circle.className = '';
                        baseClasses.forEach(cls => circle.classList.add(cls));
                        
                        // Only add completion state when 100% of stage tasks are done
                        if (stageProgress === 100) {
                            circle.classList.add('completed');
                            completedStages++;
                        }
                        // If not completed, just keep base classes (no in-progress state)
                    }
                }
            });

            // Update progress line based only on fully completed stages
            const progressLine = document.querySelector('.progress-line-fill');
            if (progressLine) {
                // Progress line advances only when entire stages are completed
                const overallProgress = (completedStages / stages.length) * 100;
                
                // Preserve existing styles and only update width
                if (!progressLine.style.transition) {
                    progressLine.style.transition = 'width 0.5s ease-in-out';
                }
                progressLine.style.width = `${overallProgress}%`;
            }
        }

        // ===== SIMPLE UNIVERSITIES APPLIED FUNCTIONALITY =====
        
        // University suggestions database
        const universities = [
            "Harvard University", "Stanford University", "Massachusetts Institute of Technology (MIT)",
            "University of California, Berkeley", "University of California, Los Angeles (UCLA)",
            "Princeton University", "Yale University", "Columbia University", "University of Chicago",
            "University of Pennsylvania", "Cornell University", "Dartmouth College", "Brown University",
            "Northwestern University", "Duke University", "Vanderbilt University", "Rice University",
            "Washington University in St. Louis", "Emory University", "Georgetown University",
            "Carnegie Mellon University", "University of Southern California", "University of Virginia",
            "University of North Carolina at Chapel Hill", "University of Michigan", "New York University",
            "Boston University", "Northeastern University", "University of Rochester", "Case Western Reserve University",
            "Tulane University", "Boston College", "Brandeis University", "University of California, San Diego",
            "University of California, Davis", "University of California, Irvine", "University of California, Santa Barbara",
            "University of Florida", "Georgia Institute of Technology", "University of Texas at Austin",
            "University of Wisconsin-Madison", "University of Illinois at Urbana-Champaign", "Ohio State University",
            "Pennsylvania State University", "University of Washington", "University of Minnesota", "Purdue University",
            "University of Maryland", "University of Pittsburgh", "Rutgers University", "University of Connecticut",
            "Arizona State University", "University of Arizona", "University of Colorado Boulder", "University of Oregon",
            "Oregon State University", "University of Utah", "University of Nevada, Las Vegas", "University of Hawaii",
            "California Institute of Technology (Caltech)", "University of California, Riverside", "University of California, Merced"
        ];

        // Modal functions
        function openAddUniversityModal() {
            document.getElementById('addUniversityModal').style.display = 'block';
            document.getElementById('universityNameInput').focus();
        }

        function closeAddUniversityModal() {
            document.getElementById('addUniversityModal').style.display = 'none';
            document.getElementById('universityForm').reset();
            document.getElementById('universitySuggestions').style.display = 'none';
            document.getElementById('applicationDateGroup').style.display = 'none';
            document.getElementById('admissionDateGroup').style.display = 'none';
        }

        // University auto-suggestions
        function showUniversitySuggestions(query) {
            const suggestionsDiv = document.getElementById('universitySuggestions');
            
            if (query.length < 2) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            const filtered = universities.filter(uni => 
                uni.toLowerCase().includes(query.toLowerCase())
            ).slice(0, 8);

            if (filtered.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            suggestionsDiv.innerHTML = filtered.map(uni => `
                <div onclick="selectUniversity('${uni}')" style="
                    padding: 0.75rem;
                    cursor: pointer;
                    border-bottom: 1px solid #f3f4f6;
                    transition: all 0.3s ease;
                " onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                    ${uni}
                </div>
            `).join('');

            suggestionsDiv.style.display = 'block';
        }

        function selectUniversity(universityName) {
            document.getElementById('universityNameInput').value = universityName;
            document.getElementById('universitySuggestions').style.display = 'none';
        }

        // Handle status change
        document.addEventListener('change', function(e) {
            if (e.target && e.target.name === 'applicationStatus') {
                const status = e.target.value;
                const applicationDateGroup = document.getElementById('applicationDateGroup');
                const admissionDateGroup = document.getElementById('admissionDateGroup');
                
                // Hide all conditional fields first
                applicationDateGroup.style.display = 'none';
                admissionDateGroup.style.display = 'none';
                
                // Show relevant fields based on status
                if (status === 'applied') {
                    applicationDateGroup.style.display = 'block';
                } else if (status === 'admitted') {
                    admissionDateGroup.style.display = 'block';
                }
            }
        });

        // Handle form submission
        document.addEventListener('submit', function(e) {
            if (e.target && e.target.id === 'universityForm') {
                e.preventDefault();
                addUniversity();
            }
        });

        // Add university
        function addUniversity() {
            const universityName = document.getElementById('universityNameInput').value;
            const status = document.querySelector('input[name="applicationStatus"]:checked')?.value;
            const applicationDate = document.getElementById('applicationDate').value;
            const admissionDate = document.getElementById('admissionDate').value;
            const notes = document.getElementById('universityNotes').value;

            if (!universityName || !status) {
                showMessage('Please fill in university name and status', 'error');
                return;
            }

            const university = {
                id: Date.now().toString(),
                name: universityName,
                status: status,
                applicationDate: applicationDate,
                admissionDate: admissionDate,
                notes: notes,
                dateAdded: new Date().toISOString()
            };

            // Get existing universities
            const universities = JSON.parse(localStorage.getItem('uternity_universities') || '[]');
            universities.push(university);
            localStorage.setItem('uternity_universities', JSON.stringify(universities));

            // Close modal and refresh display
            closeAddUniversityModal();
            loadUniversities();
            showMessage('✅ University added successfully!', 'success');
        }

        // Load and display universities
        function loadUniversities() {
            const universities = JSON.parse(localStorage.getItem('uternity_universities') || '[]');
            const container = document.getElementById('universitiesContainer');

            if (universities.length === 0) {
                container.innerHTML = `
                    <div style="
                        grid-column: 1 / -1;
                        text-align: center;
                        padding: 3rem;
                        color: #6b7280;
                    ">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">🎓</div>
                        <h3 style="color: #374151; margin-bottom: 0.5rem;">No universities added yet</h3>
                        <p>Click "Add University" to get started!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = universities.map(uni => `
                <div class="university-card" style="
                    background: white;
                    border-radius: 16px;
                    padding: 1.5rem;
                    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                    border: 2px solid ${getUniversityStatusColor(uni.status)};
                    transition: all 0.3s ease;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(0, 0, 0, 0.15)';" onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 6px -1px rgba(0, 0, 0, 0.1)';">
                    
                    <!-- Status Badge -->
                    <div style="
                        display: inline-block;
                        background: ${getUniversityStatusColor(uni.status)};
                        color: white;
                        padding: 0.25rem 0.75rem;
                        border-radius: 12px;
                        font-size: 0.75rem;
                        font-weight: 600;
                        margin-bottom: 1rem;
                    ">
                        ${getUniversityStatusText(uni.status)}
                    </div>
                    
                    <!-- University Name -->
                    <h3 style="
                        font-size: 1.1rem;
                        font-weight: 700;
                        color: #1f2937;
                        margin-bottom: 1rem;
                        line-height: 1.3;
                    ">${uni.name}</h3>
                    
                    <!-- Dates -->
                    ${uni.applicationDate ? `
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; font-size: 0.9rem;">
                            <i class="fas fa-calendar" style="color: #6b7280;"></i>
                            <span style="color: #6b7280;">Applied:</span>
                            <span style="color: #1f2937; font-weight: 500;">${formatSimpleDate(uni.applicationDate)}</span>
                        </div>
                    ` : ''}
                    
                    ${uni.admissionDate ? `
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; font-size: 0.9rem;">
                            <i class="fas fa-trophy" style="color: #10b981;"></i>
                            <span style="color: #6b7280;">Admitted:</span>
                            <span style="color: #10b981; font-weight: 600;">${formatSimpleDate(uni.admissionDate)}</span>
                        </div>
                    ` : ''}
                    
                    <!-- Notes -->
                    ${uni.notes ? `
                        <div style="
                            background: #f8fafc;
                            padding: 0.75rem;
                            border-radius: 8px;
                            margin: 1rem 0;
                        ">
                            <p style="font-size: 0.85rem; color: #4b5563; line-height: 1.4; margin: 0;">
                                ${uni.notes}
                            </p>
                        </div>
                    ` : ''}
                    
                    <!-- Actions -->
                    <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem;">
                        <button onclick="deleteUniversity('${uni.id}')" style="
                            padding: 0.5rem 1rem;
                            background: #fee2e2;
                            border: 1px solid #fecaca;
                            border-radius: 8px;
                            color: #dc2626;
                            font-size: 0.8rem;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.background='#fecaca'" onmouseout="this.style.background='#fee2e2'">
                            <i class="fas fa-trash"></i> Remove
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Helper functions
        function getUniversityStatusColor(status) {
            const colors = {
                'planning': '#6b7280',
                'applied': '#3b82f6',
                'admitted': '#10b981'
            };
            return colors[status] || '#6b7280';
        }

        function getUniversityStatusText(status) {
            const texts = {
                'planning': '📋 Planning',
                'applied': '✅ Applied',
                'admitted': '🎉 Admitted'
            };
            return texts[status] || status;
        }

        function formatSimpleDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function deleteUniversity(id) {
            if (confirm('Are you sure you want to remove this university?')) {
                const universities = JSON.parse(localStorage.getItem('uternity_universities') || '[]');
                const filtered = universities.filter(uni => uni.id !== id);
                localStorage.setItem('uternity_universities', JSON.stringify(filtered));
                loadUniversities();
                showMessage('University removed successfully', 'success');
            }
        }

        // Event listeners
        document.addEventListener('click', function(e) {
            if (e.target && e.target.id === 'addUniversityBtn') {
                openAddUniversityModal();
            }
            
            // Close modal when clicking outside
            if (e.target && e.target.id === 'addUniversityModal') {
                closeAddUniversityModal();
            }
            
            // Close suggestions when clicking outside
            if (!e.target.closest('#universityNameInput') && !e.target.closest('#universitySuggestions')) {
                document.getElementById('universitySuggestions').style.display = 'none';
            }
        });

        // ===== END SIMPLE UNIVERSITIES APPLIED FUNCTIONALITY =====

        // Load user data
        async function loadUserData() {
            try {
                // Try to get user data from localStorage first
                const storedUser = localStorage.getItem('uternity_user');
                if (storedUser) {
                    currentUser = JSON.parse(storedUser);
                    updateProfileDisplay();
                    populateFormData();
                }

                // Then try to fetch from API
                const response = await fetch('/api/auth/users/profile', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('uternity_token')}`
                    }
                });

                if (response.ok) {
                    const userData = await response.json();
                    currentUser = userData;
                    localStorage.setItem('uternity_user', JSON.stringify(userData));
                    updateProfileDisplay();
                    populateFormData();
                }
            } catch (error) {
                console.error('Failed to load user data:', error);
                // Use demo data if API fails
                currentUser = {
                    first_name: 'John',
                    last_name: 'Doe',
                    email: 'john.doe@example.com',
                    profile: {},
                    preferences: {}
                };
            }
        }



        // Populate form data
        function populateFormData() {
            if (!currentUser) return;

            // Personal information
            const personalFields = {
                firstName: currentUser.first_name,
                lastName: currentUser.last_name,
                email: currentUser.email,
                phone: currentUser.phone,
                country: currentUser.country,
                dateOfBirth: currentUser.profile?.date_of_birth,
                gender: currentUser.profile?.gender,
                linkedinUrl: currentUser.profile?.linkedin_url,
                bio: currentUser.profile?.bio
            };

            Object.entries(personalFields).forEach(([fieldId, value]) => {
                const field = document.getElementById(fieldId);
                if (field && value) {
                    field.value = value;
                }
            });

            // Preferences
            const preferences = currentUser.preferences || {};
            const settingsFields = {
                theme: preferences.theme || 'light',
                language: preferences.language || 'en',
                timezone: preferences.timezone || 'America/New_York',
                notificationFrequency: preferences.notification_frequency || 'daily'
            };

            Object.entries(settingsFields).forEach(([fieldId, value]) => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = value;
                }
            });

            // Checkboxes
            const marketingEmails = document.getElementById('marketingEmails');
            const pushNotifications = document.getElementById('pushNotifications');
            
            if (marketingEmails) marketingEmails.checked = preferences.marketing_emails !== false;
            if (pushNotifications) pushNotifications.checked = preferences.push_notifications !== false;
        }

        // Save personal information
        async function savePersonalInfo() {
            if (isLoading) return;
            
            const formData = {
                first_name: document.getElementById('firstName').value,
                last_name: document.getElementById('lastName').value,
                phone: document.getElementById('phone').value,
                country: document.getElementById('country').value,
                date_of_birth: document.getElementById('dateOfBirth').value,
                gender: document.getElementById('gender').value,
                linkedin_url: document.getElementById('linkedinUrl').value,
                bio: document.getElementById('bio').value
            };

            try {
                isLoading = true;
                showMessage('Saving personal information...', 'info');

                const response = await fetch('/api/auth/users/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('uternity_token')}`
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const updatedUser = await response.json();
                    currentUser = updatedUser;
                    localStorage.setItem('uternity_user', JSON.stringify(updatedUser));
                    updateProfileDisplay();
                    showMessage('Personal information saved successfully!', 'success');
                    updateProfileProgress(); // Update progress indicator
                } else {
                    throw new Error('Failed to save personal information');
                }
            } catch (error) {
                console.error('Save error:', error);
                showMessage('Failed to save personal information. Please try again.', 'error');
            } finally {
                isLoading = false;
            }
        }

        // Save academic information
        function saveAcademicInfo() {
            // Implementation for saving academic info
            showMessage('Academic information saved successfully!', 'success');
            updateProfileProgress(); // Update progress indicator
        }

        // Save preferences
        function savePreferences() {
            // Implementation for saving preferences
            showMessage('Preferences saved successfully!', 'success');
            updateProfileProgress(); // Update progress indicator
        }

        // Save settings
        async function saveSettings() {
            if (isLoading) return;

            const settingsData = {
                theme: document.getElementById('theme').value,
                language: document.getElementById('language').value,
                timezone: document.getElementById('timezone').value,
                notification_frequency: document.getElementById('notificationFrequency').value,
                marketing_emails: document.getElementById('marketingEmails').checked,
                push_notifications: document.getElementById('pushNotifications').checked
            };

            try {
                isLoading = true;
                showMessage('Saving settings...', 'info');

                const response = await fetch('/api/auth/users/preferences', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('uternity_token')}`
                    },
                    body: JSON.stringify(settingsData)
                });

                if (response.ok) {
                    showMessage('Settings saved successfully!', 'success');
                    updateProfileProgress(); // Update progress indicator
                } else {
                    throw new Error('Failed to save settings');
                }
            } catch (error) {
                console.error('Save error:', error);
                showMessage('Failed to save settings. Please try again.', 'error');
            } finally {
                isLoading = false;
            }
        }

        // Reset forms
        function resetPersonalForm() {
            document.getElementById('personalForm').reset();
            populateFormData();
        }

        function resetAcademicForm() {
            document.getElementById('academicForm').reset();
        }

        function resetPreferences() {
            document.querySelectorAll('.preference-card').forEach(card => {
                card.classList.remove('selected');
            });
        }

        function resetSettings() {
            document.getElementById('settingsForm').reset();
            populateFormData();
        }

        // Security functions
        function showChangePassword() {
            showMessage('Change password functionality will be available soon!', 'info');
        }

        function setup2FA() {
            showMessage('Two-factor authentication setup will be available soon!', 'info');
        }

        function viewLoginHistory() {
            showMessage('Login history will be available soon!', 'info');
        }

        function exportData() {
            showMessage('Data export functionality will be available soon!', 'info');
        }

        function deleteAccount() {
            if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
                showMessage('Account deletion functionality will be available soon!', 'info');
            }
        }

        // Show message
        function showMessage(text, type = 'info') {
            // Remove existing messages
            document.querySelectorAll('.message').forEach(msg => msg.remove());

            const message = document.createElement('div');
            message.className = `message ${type}`;
            
            const icon = type === 'success' ? 'fas fa-check-circle' : 
                        type === 'error' ? 'fas fa-exclamation-circle' : 
                        'fas fa-info-circle';
            
            message.innerHTML = `
                <i class="${icon}"></i>
                ${text}
            `;

            // Insert at the top of the active content section
            const activeSection = document.querySelector('.content-section.active');
            if (activeSection) {
                activeSection.insertBefore(message, activeSection.firstChild);
            }

            // Auto-remove after 5 seconds
            setTimeout(() => {
                message.remove();
            }, 5000);
        }

        // ============================================================================
        // BACKEND INTEGRATION - LOAD AND SAVE PROFILE DATA
        // ============================================================================

        // Load user profile data from backend
        async function loadUserProfile() {
            try {
                const token = localStorage.getItem('uternity_token');
                if (!token) {
                    showMessage('Please log in to view your profile', 'error');
                    return;
                }

                const response = await fetch('/api/auth/users/profile', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const userData = await response.json();
                    populateProfileData(userData);
                    console.log('✅ Profile data loaded successfully');
                } else if (response.status === 401) {
                    showMessage('Session expired. Please log in again.', 'error');
                    localStorage.removeItem('uternity_token');
                } else {
                    console.error('Failed to load profile data:', response.status);
                    showMessage('Failed to load profile data', 'error');
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                showMessage('Error loading profile data', 'error');
            }
        }

        // Populate form fields with user data
        function populateProfileData(userData) {
            // Personal Info fields
            const personalFields = {
                'firstName': userData.first_name || '',
                'lastName': userData.last_name || '',
                'email': userData.email || '',
                'phone': userData.phone || '',
                'country': userData.country || '',
                'bio': userData.bio || '',
                'dateOfBirth': userData.profile?.date_of_birth || '',
                'gender': userData.profile?.gender || '',
                'linkedinUrl': userData.profile?.linkedin_url || ''
            };

            // Populate personal info fields
            Object.entries(personalFields).forEach(([fieldId, value]) => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = value;
                }
            });

            // Academic Profile fields (from profile object)
            const academicFields = {
                'currentEducation': userData.profile?.current_education || '',
                'institution': userData.profile?.institution || '',
                'major': userData.profile?.major || '',
                'gpa': userData.profile?.gpa || '',
                'graduationYear': userData.profile?.graduation_year || '',
                'ieltsScore': userData.profile?.ielts_score || '',
                'toeflScore': userData.profile?.toefl_score || '',
                'satScore': userData.profile?.sat_score || '',
                'actScore': userData.profile?.act_score || '',
                'greScore': userData.profile?.gre_score || '',
                'gmatScore': userData.profile?.gmat_score || ''
            };

            // Populate academic fields
            Object.entries(academicFields).forEach(([fieldId, value]) => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = value;
                }
            });

            // University Preferences (from preferences object)
            const preferenceFields = {
                'preferredCountries': userData.preferences?.preferred_countries || '',
                'programType': userData.preferences?.program_type || '',
                'budgetRange': userData.preferences?.budget_range || '',
                'universityRanking': userData.preferences?.university_ranking || '',
                'applicationDeadline': userData.preferences?.application_deadline || '',
                'scholarshipInterest': userData.preferences?.scholarship_interest || ''
            };

            // Populate preference fields
            Object.entries(preferenceFields).forEach(([fieldId, value]) => {
                const field = document.getElementById(fieldId);
                if (field) {
                    if (field.type === 'checkbox') {
                        field.checked = value === true || value === 'true';
                    } else {
                        field.value = value;
                    }
                }
            });

            // Update profile completion
            updateProfileProgress();
        }

        // Save personal info and academic profile
        async function savePersonalAndAcademicProfile() {
            try {
                const token = localStorage.getItem('uternity_token');
                if (!token) {
                    showMessage('Please log in to save your profile', 'error');
                    return false;
                }

                // Collect personal info data
                const personalData = {
                    first_name: document.getElementById('firstName')?.value?.trim() || null,
                    last_name: document.getElementById('lastName')?.value?.trim() || null,
                    phone: document.getElementById('phone')?.value?.trim() || null,
                    country: document.getElementById('country')?.value?.trim() || null,
                    bio: document.getElementById('bio')?.value?.trim() || null,
                    date_of_birth: document.getElementById('dateOfBirth')?.value?.trim() || null,
                    gender: document.getElementById('gender')?.value?.trim() || null,
                    linkedin_url: document.getElementById('linkedinUrl')?.value?.trim() || null
                };

                // Collect academic profile data (will be stored in profile object)
                const academicData = {
                    current_education: document.getElementById('currentEducation')?.value?.trim() || null,
                    institution: document.getElementById('institution')?.value?.trim() || null,
                    major: document.getElementById('major')?.value?.trim() || null,
                    gpa: document.getElementById('gpa')?.value?.trim() || null,
                    graduation_year: document.getElementById('graduationYear')?.value?.trim() || null,
                    ielts_score: document.getElementById('ieltsScore')?.value?.trim() || null,
                    toefl_score: document.getElementById('toeflScore')?.value?.trim() || null,
                    sat_score: document.getElementById('satScore')?.value?.trim() || null,
                    act_score: document.getElementById('actScore')?.value?.trim() || null,
                    gre_score: document.getElementById('greScore')?.value?.trim() || null,
                    gmat_score: document.getElementById('gmatScore')?.value?.trim() || null
                };

                // Combine data - academic data goes into profile object
                const updateData = {
                    ...personalData,
                    profile: academicData
                };

                // Remove null values
                Object.keys(updateData).forEach(key => {
                    if (updateData[key] === null || updateData[key] === '') {
                        delete updateData[key];
                    }
                });

                // Remove null values from profile object
                if (updateData.profile) {
                    Object.keys(updateData.profile).forEach(key => {
                        if (updateData.profile[key] === null || updateData.profile[key] === '') {
                            delete updateData.profile[key];
                        }
                    });
                }

                const response = await fetch('/api/auth/users/profile', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                if (response.ok) {
                    showMessage('✅ Profile saved successfully!', 'success');
                    updateProfileProgress();
                    return true;
                } else if (response.status === 401) {
                    showMessage('Session expired. Please log in again.', 'error');
                    localStorage.removeItem('uternity_token');
                    return false;
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    showMessage(`Failed to save profile: ${errorData.detail || 'Unknown error'}`, 'error');
                    return false;
                }
            } catch (error) {
                console.error('Error saving profile:', error);
                showMessage('Error saving profile data', 'error');
                return false;
            }
        }

        // Save university preferences
        async function saveUniversityPreferences() {
            try {
                const token = localStorage.getItem('uternity_token');
                if (!token) {
                    showMessage('Please log in to save your preferences', 'error');
                    return false;
                }

                // Collect preferences data
                const preferencesData = {
                    preferred_countries: document.getElementById('preferredCountries')?.value?.trim() || null,
                    program_type: document.getElementById('programType')?.value?.trim() || null,
                    budget_range: document.getElementById('budgetRange')?.value?.trim() || null,
                    university_ranking: document.getElementById('universityRanking')?.value?.trim() || null,
                    application_deadline: document.getElementById('applicationDeadline')?.value?.trim() || null,
                    scholarship_interest: document.getElementById('scholarshipInterest')?.checked || false
                };

                // Remove null values
                Object.keys(preferencesData).forEach(key => {
                    if (preferencesData[key] === null || preferencesData[key] === '') {
                        delete preferencesData[key];
                    }
                });

                const response = await fetch('/api/auth/users/preferences', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(preferencesData)
                });

                if (response.ok) {
                    showMessage('✅ Preferences saved successfully!', 'success');
                    return true;
                } else if (response.status === 401) {
                    showMessage('Session expired. Please log in again.', 'error');
                    localStorage.removeItem('uternity_token');
                    return false;
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    showMessage(`Failed to save preferences: ${errorData.detail || 'Unknown error'}`, 'error');
                    return false;
                }
            } catch (error) {
                console.error('Error saving preferences:', error);
                showMessage('Error saving preferences data', 'error');
                return false;
            }
        }

        // Add save buttons functionality
        function setupSaveButtons() {
            // Personal Info save button
            const personalSaveBtn = document.querySelector('#personal-tab .btn-primary');
            if (personalSaveBtn) {
                personalSaveBtn.onclick = savePersonalAndAcademicProfile;
            }

            // Academic Profile save button
            const academicSaveBtn = document.querySelector('#academic-tab .btn-primary');
            if (academicSaveBtn) {
                academicSaveBtn.onclick = savePersonalAndAcademicProfile;
            }

            // University Preferences save button
            const preferencesSaveBtn = document.querySelector('#preferences-tab .btn-primary');
            if (preferencesSaveBtn) {
                preferencesSaveBtn.onclick = saveUniversityPreferences;
            }
        }

        // Initialize profile functionality
        function initializeProfileFunctionality() {
            // Load user profile data on page load
            loadUserProfile();
            
            // Setup save button functionality
            setupSaveButtons();
            
            // Setup form auto-save on change (optional)
            const forms = document.querySelectorAll('form');
            forms.forEach(form => {
                form.addEventListener('change', () => {
                    // Auto-update progress when fields change
                    setTimeout(updateProfileProgress, 100);
                });
            });
        }

        // Call initialization when DOM is ready
        document.addEventListener('DOMContentLoaded', initializeProfileFunctionality);

        console.log('✅ Profile page initialized successfully!');
    </script>
</body>
</html>
