<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth Debug - UTERNITY</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .debug-item {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status-good { border-left: 4px solid #10b981; }
        .status-bad { border-left: 4px solid #ef4444; }
        .status-warning { border-left: 4px solid #f59e0b; }
        .code-block {
            background: #f3f4f6;
            border-radius: 4px;
            padding: 12px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-white mb-8 text-center">🔍 Authentication Debug Center</h1>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Auth API Status -->
            <div class="debug-item" id="authApiStatus">
                <h3 class="text-lg font-semibold mb-3">🔐 Auth API Status</h3>
                <div id="authApiContent">Loading...</div>
            </div>

            <!-- Auth Guard Status -->
            <div class="debug-item" id="authGuardStatus">
                <h3 class="text-lg font-semibold mb-3">🛡️ Auth Guard Status</h3>
                <div id="authGuardContent">Loading...</div>
            </div>

            <!-- localStorage Contents -->
            <div class="debug-item" id="localStorageStatus">
                <h3 class="text-lg font-semibold mb-3">💾 LocalStorage Contents</h3>
                <div id="localStorageContent">Loading...</div>
            </div>

            <!-- Session Storage Contents -->
            <div class="debug-item" id="sessionStorageStatus">
                <h3 class="text-lg font-semibold mb-3">📝 SessionStorage Contents</h3>
                <div id="sessionStorageContent">Loading...</div>
            </div>

            <!-- Current User Data -->
            <div class="debug-item" id="userDataStatus">
                <h3 class="text-lg font-semibold mb-3">👤 Current User Data</h3>
                <div id="userDataContent">Loading...</div>
            </div>

            <!-- Navigation Test -->
            <div class="debug-item" id="navTestStatus">
                <h3 class="text-lg font-semibold mb-3">🧭 Navigation Test</h3>
                <div id="navTestContent">
                    <button id="testDashboard" class="bg-purple-600 text-white px-4 py-2 rounded mr-2 mb-2">Test Dashboard</button>
                    <button id="testLogin" class="bg-blue-600 text-white px-4 py-2 rounded mr-2 mb-2">Test Login</button>
                    <button id="forceLogin" class="bg-green-600 text-white px-4 py-2 rounded mr-2 mb-2">Force Login</button>
                    <button id="clearStorage" class="bg-red-600 text-white px-4 py-2 rounded mr-2 mb-2">Clear Storage</button>
                    <div id="navTestResult" class="mt-3 p-3 bg-gray-100 rounded text-sm"></div>
                </div>
            </div>
        </div>

        <!-- Real-time Log -->
        <div class="debug-item mt-6">
            <h3 class="text-lg font-semibold mb-3">📋 Real-time Log</h3>
            <div id="realTimeLog" class="code-block h-40 bg-black text-green-400">
                <div>🚀 Debug page loaded - Starting diagnostics...</div>
            </div>
        </div>
    </div>

    <!-- Auth Scripts -->
    <script src="js/auth-api.js"></script>
    <script src="js/auth-guard.js"></script>

    <script>
        function log(message) {
            const logElement = document.getElementById('realTimeLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${timestamp}] ${message}`;
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStatus(elementId, content, statusClass = 'status-good') {
            const element = document.getElementById(elementId);
            element.className = `debug-item ${statusClass}`;
            document.getElementById(elementId.replace('Status', 'Content')).innerHTML = content;
        }

        function checkAuthAPI() {
            log('🔍 Checking Auth API...');
            
            if (typeof window.authAPI === 'undefined' || !window.authAPI) {
                updateStatus('authApiStatus', '❌ Auth API not available', 'status-bad');
                return null;
            }

            const isAuth = window.authAPI.isAuthenticated();
            const user = window.authAPI.getUser();
            const accessToken = window.authAPI.accessToken;
            const refreshToken = window.authAPI.refreshToken;

            const content = `
                <div><strong>Available:</strong> ✅ Yes</div>
                <div><strong>Is Authenticated:</strong> ${isAuth ? '✅' : '❌'} ${isAuth}</div>
                <div><strong>User Data:</strong> ${user ? '✅ Loaded' : '❌ None'}</div>
                <div><strong>Access Token:</strong> ${accessToken ? '✅ Present' : '❌ Missing'}</div>
                <div><strong>Refresh Token:</strong> ${refreshToken ? '✅ Present' : '❌ Missing'}</div>
                ${user ? `<div class="code-block mt-2">${JSON.stringify(user, null, 2)}</div>` : ''}
            `;

            updateStatus('authApiStatus', content, isAuth ? 'status-good' : 'status-bad');
            return { isAuth, user, accessToken, refreshToken };
        }

        function checkAuthGuard() {
            log('🛡️ Checking Auth Guard...');
            
            if (typeof window.authGuard === 'undefined' || !window.authGuard) {
                updateStatus('authGuardStatus', '❌ Auth Guard not available', 'status-bad');
                return;
            }

            const isInit = window.authGuard.isInitialized;
            const currentUser = window.authGuard.currentUser;
            const isUserAuth = window.authGuard.isUserAuthenticated();
            const currentPath = window.location.pathname;
            const isProtected = window.authGuard.isProtectedPage(currentPath);
            const isAuthPage = window.authGuard.isAuthPage(currentPath);

            const content = `
                <div><strong>Available:</strong> ✅ Yes</div>
                <div><strong>Initialized:</strong> ${isInit ? '✅' : '❌'} ${isInit}</div>
                <div><strong>User Authenticated:</strong> ${isUserAuth ? '✅' : '❌'} ${isUserAuth}</div>
                <div><strong>Current Path:</strong> ${currentPath}</div>
                <div><strong>Is Protected Page:</strong> ${isProtected ? '🔒 Yes' : '🔓 No'}</div>
                <div><strong>Is Auth Page:</strong> ${isAuthPage ? '🚪 Yes' : '📄 No'}</div>
                ${currentUser ? `<div class="code-block mt-2">${JSON.stringify(currentUser, null, 2)}</div>` : ''}
            `;

            updateStatus('authGuardStatus', content, isUserAuth ? 'status-good' : 'status-warning');
        }

        function checkLocalStorage() {
            log('💾 Checking LocalStorage...');
            
            const keys = ['uternity_access_token', 'uternity_refresh_token', 'uternity_user'];
            let content = '';
            let hasTokens = false;

            keys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    hasTokens = true;
                    content += `<div><strong>${key}:</strong> ✅ Present</div>`;
                    if (key === 'uternity_user') {
                        try {
                            const parsed = JSON.parse(value);
                            content += `<div class="code-block mt-1">${JSON.stringify(parsed, null, 2)}</div>`;
                        } catch (e) {
                            content += `<div class="text-red-600">❌ Invalid JSON: ${value}</div>`;
                        }
                    } else {
                        // Show first and last 20 chars of tokens
                        const display = value.length > 40 ? 
                            `${value.substring(0, 20)}...${value.substring(value.length - 20)}` : 
                            value;
                        content += `<div class="code-block text-xs mt-1">${display}</div>`;
                    }
                } else {
                    content += `<div><strong>${key}:</strong> ❌ Missing</div>`;
                }
            });

            updateStatus('localStorageStatus', content, hasTokens ? 'status-good' : 'status-bad');
        }

        function checkSessionStorage() {
            log('📝 Checking SessionStorage...');
            
            const authRedirect = sessionStorage.getItem('auth_redirect');
            const content = `
                <div><strong>auth_redirect:</strong> ${authRedirect ? `📍 ${authRedirect}` : '❌ None'}</div>
                <div><strong>Total Items:</strong> ${sessionStorage.length}</div>
            `;

            updateStatus('sessionStorageStatus', content, 'status-good');
        }

        function checkUserData() {
            log('👤 Checking User Data...');
            
            const authData = checkAuthAPI();
            if (!authData || !authData.isAuth || !authData.user) {
                updateStatus('userDataStatus', '❌ No authenticated user data available', 'status-bad');
                return;
            }

            const user = authData.user;
            const content = `
                <div><strong>Name:</strong> ${user.first_name} ${user.last_name}</div>
                <div><strong>Email:</strong> ${user.email}</div>
                <div><strong>ID:</strong> ${user.id}</div>
                <div><strong>Created:</strong> ${user.created_at}</div>
                <div><strong>Active:</strong> ${user.is_active ? '✅' : '❌'}</div>
                <div class="code-block mt-2">${JSON.stringify(user, null, 2)}</div>
            `;

            updateStatus('userDataStatus', content, 'status-good');
        }

        function runAllChecks() {
            log('🔄 Running all diagnostic checks...');
            setTimeout(() => {
                checkAuthAPI();
                checkAuthGuard();
                checkLocalStorage();
                checkSessionStorage();
                checkUserData();
                log('✅ All checks completed');
            }, 500);
        }

        // Navigation tests
        document.getElementById('testDashboard').addEventListener('click', function() {
            log('🏠 Testing dashboard navigation...');
            const result = document.getElementById('navTestResult');
            result.innerHTML = 'Navigating to dashboard...';
            setTimeout(() => {
                window.location.href = '/pages/app/dashboard.html';
            }, 1000);
        });

        document.getElementById('testLogin').addEventListener('click', function() {
            log('🚪 Testing login navigation...');
            const result = document.getElementById('navTestResult');
            result.innerHTML = 'Navigating to login...';
            setTimeout(() => {
                window.location.href = '/pages/app/auth/login.html';
            }, 1000);
        });

        document.getElementById('forceLogin').addEventListener('click', async function() {
            log('🔐 Forcing login with test credentials...');
            const result = document.getElementById('navTestResult');
            result.innerHTML = 'Attempting auto-login...';
            
            try {
                if (window.authAPI) {
                    const response = await window.authAPI.login({
                        email: 'test3@example.com',
                        password: 'TestPassword123!'
                    });
                    result.innerHTML = '✅ Login successful! Refreshing page...';
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    result.innerHTML = '❌ Auth API not available';
                }
            } catch (error) {
                result.innerHTML = `❌ Login failed: ${error.message}`;
                log(`❌ Auto-login failed: ${error.message}`);
            }
        });

        document.getElementById('clearStorage').addEventListener('click', function() {
            log('🗑️ Clearing all storage...');
            localStorage.clear();
            sessionStorage.clear();
            const result = document.getElementById('navTestResult');
            result.innerHTML = '🗑️ Storage cleared! Refreshing page...';
            setTimeout(() => window.location.reload(), 1000);
        });

        // Initialize
        log('🚀 Auth Debug page ready');
        runAllChecks();

        // Refresh checks every 10 seconds
        setInterval(runAllChecks, 10000);
    </script>
</body>
</html> 